<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>RabbitMQ | 狸猫小僧</title>
    <meta name="generator" content="VuePress 1.8.3">
    <link rel="icon" href="/favicon.ico">
    <link rel="manifest" href="/manifest.json">
    <meta name="description" content="记录点滴足迹  保留美好时光">
    
    <link rel="preload" href="/assets/css/0.styles.89e32c3d.css" as="style"><link rel="preload" href="/assets/js/app.318be929.js" as="script"><link rel="preload" href="/assets/js/5.120864d5.js" as="script"><link rel="preload" href="/assets/js/17.103a3d21.js" as="script"><link rel="prefetch" href="/assets/js/10.1688a8e7.js"><link rel="prefetch" href="/assets/js/100.091e7d18.js"><link rel="prefetch" href="/assets/js/101.25411965.js"><link rel="prefetch" href="/assets/js/102.f0102390.js"><link rel="prefetch" href="/assets/js/103.f08a64f4.js"><link rel="prefetch" href="/assets/js/104.a02d074d.js"><link rel="prefetch" href="/assets/js/105.def2133a.js"><link rel="prefetch" href="/assets/js/106.35164556.js"><link rel="prefetch" href="/assets/js/107.b5db55ba.js"><link rel="prefetch" href="/assets/js/108.843760ad.js"><link rel="prefetch" href="/assets/js/109.9797149e.js"><link rel="prefetch" href="/assets/js/11.24b87beb.js"><link rel="prefetch" href="/assets/js/110.be4a9d7f.js"><link rel="prefetch" href="/assets/js/111.c17d6145.js"><link rel="prefetch" href="/assets/js/112.a87faa02.js"><link rel="prefetch" href="/assets/js/113.da156e6a.js"><link rel="prefetch" href="/assets/js/114.39fb0a52.js"><link rel="prefetch" href="/assets/js/115.c98bbe7b.js"><link rel="prefetch" href="/assets/js/116.4a50fe26.js"><link rel="prefetch" href="/assets/js/117.3c05826e.js"><link rel="prefetch" href="/assets/js/118.72bc9cfc.js"><link rel="prefetch" href="/assets/js/119.9536c635.js"><link rel="prefetch" href="/assets/js/12.c59d467a.js"><link rel="prefetch" href="/assets/js/120.c050bd90.js"><link rel="prefetch" href="/assets/js/121.11cad23d.js"><link rel="prefetch" href="/assets/js/122.17d63f6d.js"><link rel="prefetch" href="/assets/js/123.ff7a7ec1.js"><link rel="prefetch" href="/assets/js/124.893f3a05.js"><link rel="prefetch" href="/assets/js/125.41f15890.js"><link rel="prefetch" href="/assets/js/126.831e8ecb.js"><link rel="prefetch" href="/assets/js/127.42d02e80.js"><link rel="prefetch" href="/assets/js/128.a4e7ea02.js"><link rel="prefetch" href="/assets/js/129.82382c3e.js"><link rel="prefetch" href="/assets/js/13.192bce47.js"><link rel="prefetch" href="/assets/js/130.2155b4e0.js"><link rel="prefetch" href="/assets/js/131.8a0300b0.js"><link rel="prefetch" href="/assets/js/132.f4921dbb.js"><link rel="prefetch" href="/assets/js/133.475bbb1d.js"><link rel="prefetch" href="/assets/js/134.78f4fdfc.js"><link rel="prefetch" href="/assets/js/135.9b9cbc0b.js"><link rel="prefetch" href="/assets/js/136.9c6df94f.js"><link rel="prefetch" href="/assets/js/137.e2f26625.js"><link rel="prefetch" href="/assets/js/138.211b024d.js"><link rel="prefetch" href="/assets/js/139.2ce7e73b.js"><link rel="prefetch" href="/assets/js/14.934d0c9a.js"><link rel="prefetch" href="/assets/js/140.96f53e64.js"><link rel="prefetch" href="/assets/js/141.923dc72f.js"><link rel="prefetch" href="/assets/js/142.925d811e.js"><link rel="prefetch" href="/assets/js/143.2e457677.js"><link rel="prefetch" href="/assets/js/144.5698756b.js"><link rel="prefetch" href="/assets/js/145.a2afc635.js"><link rel="prefetch" href="/assets/js/146.ebc2d165.js"><link rel="prefetch" href="/assets/js/147.cbc5c74b.js"><link rel="prefetch" href="/assets/js/148.4b9380a1.js"><link rel="prefetch" href="/assets/js/149.ab96d823.js"><link rel="prefetch" href="/assets/js/15.b28faa87.js"><link rel="prefetch" href="/assets/js/150.e8965844.js"><link rel="prefetch" href="/assets/js/151.9713a9f5.js"><link rel="prefetch" href="/assets/js/152.54534435.js"><link rel="prefetch" href="/assets/js/153.1e462b32.js"><link rel="prefetch" href="/assets/js/154.888f6cd4.js"><link rel="prefetch" href="/assets/js/155.fbf963bb.js"><link rel="prefetch" href="/assets/js/156.fec6872a.js"><link rel="prefetch" href="/assets/js/157.240e7f37.js"><link rel="prefetch" href="/assets/js/158.cce19f98.js"><link rel="prefetch" href="/assets/js/159.84b0d0f0.js"><link rel="prefetch" href="/assets/js/16.56cfcba7.js"><link rel="prefetch" href="/assets/js/160.fb1d7f95.js"><link rel="prefetch" href="/assets/js/161.5847e719.js"><link rel="prefetch" href="/assets/js/162.d2c0533c.js"><link rel="prefetch" href="/assets/js/163.8807735d.js"><link rel="prefetch" href="/assets/js/164.e1590ae0.js"><link rel="prefetch" href="/assets/js/165.048805af.js"><link rel="prefetch" href="/assets/js/166.8103b23c.js"><link rel="prefetch" href="/assets/js/167.64957986.js"><link rel="prefetch" href="/assets/js/168.c8e519d8.js"><link rel="prefetch" href="/assets/js/169.4ff32eba.js"><link rel="prefetch" href="/assets/js/170.82a89b3e.js"><link rel="prefetch" href="/assets/js/171.281a043d.js"><link rel="prefetch" href="/assets/js/172.7516d620.js"><link rel="prefetch" href="/assets/js/173.e597d47c.js"><link rel="prefetch" href="/assets/js/174.b23a1946.js"><link rel="prefetch" href="/assets/js/175.3f0baafb.js"><link rel="prefetch" href="/assets/js/176.262d6917.js"><link rel="prefetch" href="/assets/js/177.09974955.js"><link rel="prefetch" href="/assets/js/178.af7f71bc.js"><link rel="prefetch" href="/assets/js/179.118041c1.js"><link rel="prefetch" href="/assets/js/18.a6ae928f.js"><link rel="prefetch" href="/assets/js/180.c63c00b1.js"><link rel="prefetch" href="/assets/js/181.2e486019.js"><link rel="prefetch" href="/assets/js/182.68df2139.js"><link rel="prefetch" href="/assets/js/183.384919e8.js"><link rel="prefetch" href="/assets/js/184.499d5539.js"><link rel="prefetch" href="/assets/js/185.a9792c82.js"><link rel="prefetch" href="/assets/js/186.e5950899.js"><link rel="prefetch" href="/assets/js/187.82fa963f.js"><link rel="prefetch" href="/assets/js/188.25246756.js"><link rel="prefetch" href="/assets/js/189.67ca0adf.js"><link rel="prefetch" href="/assets/js/19.d1cd7732.js"><link rel="prefetch" href="/assets/js/190.d2e6e4f1.js"><link rel="prefetch" href="/assets/js/191.fee7d370.js"><link rel="prefetch" href="/assets/js/192.e67a4824.js"><link rel="prefetch" href="/assets/js/193.d48f3921.js"><link rel="prefetch" href="/assets/js/194.5ff25ccc.js"><link rel="prefetch" href="/assets/js/195.aa453c8b.js"><link rel="prefetch" href="/assets/js/196.dba5e1d1.js"><link rel="prefetch" href="/assets/js/197.49b3a863.js"><link rel="prefetch" href="/assets/js/198.06e6c738.js"><link rel="prefetch" href="/assets/js/199.761f1b5b.js"><link rel="prefetch" href="/assets/js/20.27ff214b.js"><link rel="prefetch" href="/assets/js/200.140f7152.js"><link rel="prefetch" href="/assets/js/201.7ab1029d.js"><link rel="prefetch" href="/assets/js/202.57bc8181.js"><link rel="prefetch" href="/assets/js/203.79ca07a4.js"><link rel="prefetch" href="/assets/js/204.57e04f64.js"><link rel="prefetch" href="/assets/js/205.1f13c744.js"><link rel="prefetch" href="/assets/js/206.c5638679.js"><link rel="prefetch" href="/assets/js/207.0a316141.js"><link rel="prefetch" href="/assets/js/208.e51aec2d.js"><link rel="prefetch" href="/assets/js/209.3b1497d2.js"><link rel="prefetch" href="/assets/js/21.0ba3568a.js"><link rel="prefetch" href="/assets/js/210.3acff9e1.js"><link rel="prefetch" href="/assets/js/211.8a68e1d7.js"><link rel="prefetch" href="/assets/js/212.e0fb5d39.js"><link rel="prefetch" href="/assets/js/213.b64b1d26.js"><link rel="prefetch" href="/assets/js/214.98df03ef.js"><link rel="prefetch" href="/assets/js/215.e80ae72f.js"><link rel="prefetch" href="/assets/js/216.212d9b33.js"><link rel="prefetch" href="/assets/js/217.14fc8c56.js"><link rel="prefetch" href="/assets/js/218.bacdeca1.js"><link rel="prefetch" href="/assets/js/219.7fcc1e69.js"><link rel="prefetch" href="/assets/js/22.48435abe.js"><link rel="prefetch" href="/assets/js/220.32030f45.js"><link rel="prefetch" href="/assets/js/221.e36ad720.js"><link rel="prefetch" href="/assets/js/222.5d122212.js"><link rel="prefetch" href="/assets/js/223.254a5b38.js"><link rel="prefetch" href="/assets/js/224.9e987c75.js"><link rel="prefetch" href="/assets/js/225.4c310670.js"><link rel="prefetch" href="/assets/js/226.a6a842df.js"><link rel="prefetch" href="/assets/js/227.7e88e03e.js"><link rel="prefetch" href="/assets/js/228.f965e295.js"><link rel="prefetch" href="/assets/js/229.729536e7.js"><link rel="prefetch" href="/assets/js/23.b77ed03b.js"><link rel="prefetch" href="/assets/js/230.af6eebee.js"><link rel="prefetch" href="/assets/js/231.57266b06.js"><link rel="prefetch" href="/assets/js/232.050fa7f5.js"><link rel="prefetch" href="/assets/js/233.9b546050.js"><link rel="prefetch" href="/assets/js/234.ff65222d.js"><link rel="prefetch" href="/assets/js/235.7e7fdea7.js"><link rel="prefetch" href="/assets/js/236.ef624120.js"><link rel="prefetch" href="/assets/js/237.ee537b40.js"><link rel="prefetch" href="/assets/js/238.d60689ed.js"><link rel="prefetch" href="/assets/js/239.fd2eab6a.js"><link rel="prefetch" href="/assets/js/24.f6cfb813.js"><link rel="prefetch" href="/assets/js/240.e7c94b91.js"><link rel="prefetch" href="/assets/js/241.fdb8bae1.js"><link rel="prefetch" href="/assets/js/242.ef14b027.js"><link rel="prefetch" href="/assets/js/243.bdc21e00.js"><link rel="prefetch" href="/assets/js/244.71e5f42e.js"><link rel="prefetch" href="/assets/js/245.be420b95.js"><link rel="prefetch" href="/assets/js/246.8ce7d422.js"><link rel="prefetch" href="/assets/js/247.018d9d03.js"><link rel="prefetch" href="/assets/js/248.3f5ac07e.js"><link rel="prefetch" href="/assets/js/249.79458e3b.js"><link rel="prefetch" href="/assets/js/25.b453286c.js"><link rel="prefetch" href="/assets/js/250.944df71c.js"><link rel="prefetch" href="/assets/js/251.ae6db736.js"><link rel="prefetch" href="/assets/js/252.08928642.js"><link rel="prefetch" href="/assets/js/253.47b68438.js"><link rel="prefetch" href="/assets/js/254.4ff5bcf7.js"><link rel="prefetch" href="/assets/js/255.cb7faec9.js"><link rel="prefetch" href="/assets/js/256.c4f0d37a.js"><link rel="prefetch" href="/assets/js/257.47c21c6d.js"><link rel="prefetch" href="/assets/js/258.418d99e5.js"><link rel="prefetch" href="/assets/js/259.e490c726.js"><link rel="prefetch" href="/assets/js/26.9a089344.js"><link rel="prefetch" href="/assets/js/260.0854352f.js"><link rel="prefetch" href="/assets/js/261.c21732b4.js"><link rel="prefetch" href="/assets/js/262.c363787d.js"><link rel="prefetch" href="/assets/js/263.6ec7e0c8.js"><link rel="prefetch" href="/assets/js/264.5e98b699.js"><link rel="prefetch" href="/assets/js/265.d4589b4d.js"><link rel="prefetch" href="/assets/js/266.6104d44e.js"><link rel="prefetch" href="/assets/js/267.13c2840f.js"><link rel="prefetch" href="/assets/js/268.8eb1958f.js"><link rel="prefetch" href="/assets/js/269.b0da23f7.js"><link rel="prefetch" href="/assets/js/27.da888387.js"><link rel="prefetch" href="/assets/js/270.ef88e463.js"><link rel="prefetch" href="/assets/js/271.eb9c1ae3.js"><link rel="prefetch" href="/assets/js/272.174b324a.js"><link rel="prefetch" href="/assets/js/273.9e601ce2.js"><link rel="prefetch" href="/assets/js/274.e7fa45bb.js"><link rel="prefetch" href="/assets/js/275.6443a129.js"><link rel="prefetch" href="/assets/js/276.2499b321.js"><link rel="prefetch" href="/assets/js/277.9ef82d65.js"><link rel="prefetch" href="/assets/js/278.2a80a579.js"><link rel="prefetch" href="/assets/js/279.1ef730df.js"><link rel="prefetch" href="/assets/js/28.9d007e66.js"><link rel="prefetch" href="/assets/js/280.c9fd25bb.js"><link rel="prefetch" href="/assets/js/281.70958364.js"><link rel="prefetch" href="/assets/js/282.4475339e.js"><link rel="prefetch" href="/assets/js/283.01dbb702.js"><link rel="prefetch" href="/assets/js/284.ea8a78fe.js"><link rel="prefetch" href="/assets/js/285.819be19f.js"><link rel="prefetch" href="/assets/js/286.21b75494.js"><link rel="prefetch" href="/assets/js/287.71efeae0.js"><link rel="prefetch" href="/assets/js/288.120b679d.js"><link rel="prefetch" href="/assets/js/289.ca505942.js"><link rel="prefetch" href="/assets/js/29.7036c505.js"><link rel="prefetch" href="/assets/js/290.7c7a9a4e.js"><link rel="prefetch" href="/assets/js/291.d99fb5e2.js"><link rel="prefetch" href="/assets/js/292.9599b7df.js"><link rel="prefetch" href="/assets/js/293.b7aaf871.js"><link rel="prefetch" href="/assets/js/294.a3f7a112.js"><link rel="prefetch" href="/assets/js/295.189b97ad.js"><link rel="prefetch" href="/assets/js/296.60d9bb55.js"><link rel="prefetch" href="/assets/js/297.9db97ef0.js"><link rel="prefetch" href="/assets/js/298.c4b54bc3.js"><link rel="prefetch" href="/assets/js/299.db939334.js"><link rel="prefetch" href="/assets/js/3.cd0e8410.js"><link rel="prefetch" href="/assets/js/30.36107184.js"><link rel="prefetch" href="/assets/js/300.66abea7e.js"><link rel="prefetch" href="/assets/js/301.a010de8d.js"><link rel="prefetch" href="/assets/js/302.0d2cbb20.js"><link rel="prefetch" href="/assets/js/303.c1dd97a0.js"><link rel="prefetch" href="/assets/js/304.07f2b9ae.js"><link rel="prefetch" href="/assets/js/305.c43caeaa.js"><link rel="prefetch" href="/assets/js/306.45cd64f2.js"><link rel="prefetch" href="/assets/js/307.4865da11.js"><link rel="prefetch" href="/assets/js/308.3d075b14.js"><link rel="prefetch" href="/assets/js/309.af01438b.js"><link rel="prefetch" href="/assets/js/31.ffa829b2.js"><link rel="prefetch" href="/assets/js/310.a76ede8b.js"><link rel="prefetch" href="/assets/js/311.16d0f188.js"><link rel="prefetch" href="/assets/js/312.e8d52689.js"><link rel="prefetch" href="/assets/js/313.b3fa68a9.js"><link rel="prefetch" href="/assets/js/314.f26b4587.js"><link rel="prefetch" href="/assets/js/315.a42c71f5.js"><link rel="prefetch" href="/assets/js/316.caa3e172.js"><link rel="prefetch" href="/assets/js/317.24b8d76b.js"><link rel="prefetch" href="/assets/js/318.e0a7937a.js"><link rel="prefetch" href="/assets/js/319.f5726db9.js"><link rel="prefetch" href="/assets/js/32.9849dc78.js"><link rel="prefetch" href="/assets/js/320.421c5d94.js"><link rel="prefetch" href="/assets/js/321.ce737fb6.js"><link rel="prefetch" href="/assets/js/322.40626230.js"><link rel="prefetch" href="/assets/js/323.80055d24.js"><link rel="prefetch" href="/assets/js/324.8ac0833d.js"><link rel="prefetch" href="/assets/js/325.8649b263.js"><link rel="prefetch" href="/assets/js/326.2c8aa67a.js"><link rel="prefetch" href="/assets/js/327.77e71396.js"><link rel="prefetch" href="/assets/js/328.89ef7008.js"><link rel="prefetch" href="/assets/js/329.1e353020.js"><link rel="prefetch" href="/assets/js/33.9ad0e04b.js"><link rel="prefetch" href="/assets/js/330.497fe449.js"><link rel="prefetch" href="/assets/js/331.1c8484f2.js"><link rel="prefetch" href="/assets/js/332.a58b24f5.js"><link rel="prefetch" href="/assets/js/333.9a83b156.js"><link rel="prefetch" href="/assets/js/334.ae6bbd5e.js"><link rel="prefetch" href="/assets/js/335.e189606d.js"><link rel="prefetch" href="/assets/js/336.f25d63a9.js"><link rel="prefetch" href="/assets/js/337.607e6491.js"><link rel="prefetch" href="/assets/js/338.67418939.js"><link rel="prefetch" href="/assets/js/339.09b3741e.js"><link rel="prefetch" href="/assets/js/34.319088d7.js"><link rel="prefetch" href="/assets/js/340.524ae860.js"><link rel="prefetch" href="/assets/js/341.1a8edd92.js"><link rel="prefetch" href="/assets/js/342.6ce2e00f.js"><link rel="prefetch" href="/assets/js/343.ce80af58.js"><link rel="prefetch" href="/assets/js/344.41bf9c3e.js"><link rel="prefetch" href="/assets/js/345.2b1262bd.js"><link rel="prefetch" href="/assets/js/346.cea26caf.js"><link rel="prefetch" href="/assets/js/347.6f5e1859.js"><link rel="prefetch" href="/assets/js/348.8f557724.js"><link rel="prefetch" href="/assets/js/349.d8444d0c.js"><link rel="prefetch" href="/assets/js/35.5e556c9a.js"><link rel="prefetch" href="/assets/js/350.fc391109.js"><link rel="prefetch" href="/assets/js/351.d6cf2e07.js"><link rel="prefetch" href="/assets/js/352.1d02798a.js"><link rel="prefetch" href="/assets/js/353.0ce7c4f5.js"><link rel="prefetch" href="/assets/js/354.03bb7df4.js"><link rel="prefetch" href="/assets/js/355.c164cd3d.js"><link rel="prefetch" href="/assets/js/356.d331ed7d.js"><link rel="prefetch" href="/assets/js/357.0274d2ba.js"><link rel="prefetch" href="/assets/js/36.117af125.js"><link rel="prefetch" href="/assets/js/37.2e5cb4a5.js"><link rel="prefetch" href="/assets/js/38.ffafc3ff.js"><link rel="prefetch" href="/assets/js/39.de68c977.js"><link rel="prefetch" href="/assets/js/4.16e42b78.js"><link rel="prefetch" href="/assets/js/40.7e8d6c4d.js"><link rel="prefetch" href="/assets/js/41.cadae5a3.js"><link rel="prefetch" href="/assets/js/42.f8a790a4.js"><link rel="prefetch" href="/assets/js/43.8f821ac7.js"><link rel="prefetch" href="/assets/js/44.ac8c2cd0.js"><link rel="prefetch" href="/assets/js/45.f6941b58.js"><link rel="prefetch" href="/assets/js/46.10ad2146.js"><link rel="prefetch" href="/assets/js/47.cb5f3248.js"><link rel="prefetch" href="/assets/js/48.6a84f902.js"><link rel="prefetch" href="/assets/js/49.88dc87df.js"><link rel="prefetch" href="/assets/js/50.f314d0a4.js"><link rel="prefetch" href="/assets/js/51.a560106e.js"><link rel="prefetch" href="/assets/js/52.41c07472.js"><link rel="prefetch" href="/assets/js/53.c5553715.js"><link rel="prefetch" href="/assets/js/54.32067c04.js"><link rel="prefetch" href="/assets/js/55.fce95b5b.js"><link rel="prefetch" href="/assets/js/56.b8b070ef.js"><link rel="prefetch" href="/assets/js/57.570c5366.js"><link rel="prefetch" href="/assets/js/58.ff338315.js"><link rel="prefetch" href="/assets/js/59.06b5d5da.js"><link rel="prefetch" href="/assets/js/6.dd59264c.js"><link rel="prefetch" href="/assets/js/60.6ec9a678.js"><link rel="prefetch" href="/assets/js/61.cd9b80f8.js"><link rel="prefetch" href="/assets/js/62.ae825ba2.js"><link rel="prefetch" href="/assets/js/63.3a42bcc5.js"><link rel="prefetch" href="/assets/js/64.07869863.js"><link rel="prefetch" href="/assets/js/65.e385936e.js"><link rel="prefetch" href="/assets/js/66.0167fddd.js"><link rel="prefetch" href="/assets/js/67.33e4eb32.js"><link rel="prefetch" href="/assets/js/68.69a300c7.js"><link rel="prefetch" href="/assets/js/69.7e78f239.js"><link rel="prefetch" href="/assets/js/7.ca0a84bc.js"><link rel="prefetch" href="/assets/js/70.e66f547d.js"><link rel="prefetch" href="/assets/js/71.bcf11bf9.js"><link rel="prefetch" href="/assets/js/72.db1f2ba7.js"><link rel="prefetch" href="/assets/js/73.10357459.js"><link rel="prefetch" href="/assets/js/74.6697a003.js"><link rel="prefetch" href="/assets/js/75.de3c2931.js"><link rel="prefetch" href="/assets/js/76.d659c52e.js"><link rel="prefetch" href="/assets/js/77.550dbae2.js"><link rel="prefetch" href="/assets/js/78.ab2fabea.js"><link rel="prefetch" href="/assets/js/79.eb4f8dbb.js"><link rel="prefetch" href="/assets/js/8.086a3516.js"><link rel="prefetch" href="/assets/js/80.87e32eeb.js"><link rel="prefetch" href="/assets/js/81.7bf4f821.js"><link rel="prefetch" href="/assets/js/82.9fdbe6a6.js"><link rel="prefetch" href="/assets/js/83.c48caee9.js"><link rel="prefetch" href="/assets/js/84.340ca2bd.js"><link rel="prefetch" href="/assets/js/85.461aca60.js"><link rel="prefetch" href="/assets/js/86.cba3f34f.js"><link rel="prefetch" href="/assets/js/87.b8ac5365.js"><link rel="prefetch" href="/assets/js/88.90e460f0.js"><link rel="prefetch" href="/assets/js/89.84c2a65d.js"><link rel="prefetch" href="/assets/js/9.415fb7a2.js"><link rel="prefetch" href="/assets/js/90.c9e927b6.js"><link rel="prefetch" href="/assets/js/91.da9acfd9.js"><link rel="prefetch" href="/assets/js/92.fe54c542.js"><link rel="prefetch" href="/assets/js/93.cc6be7d4.js"><link rel="prefetch" href="/assets/js/94.10b72794.js"><link rel="prefetch" href="/assets/js/95.4a92b56b.js"><link rel="prefetch" href="/assets/js/96.de7b8e02.js"><link rel="prefetch" href="/assets/js/97.6c61fd2a.js"><link rel="prefetch" href="/assets/js/98.a399220b.js"><link rel="prefetch" href="/assets/js/99.3164b69b.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.ae42e70e.js">
    <link rel="stylesheet" href="/assets/css/0.styles.89e32c3d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/zh/" class="home-link router-link-active"><!----> <span class="site-name">狸猫小僧</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/zh/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/zh/guide/" class="nav-link">
  指南
</a></div><div class="nav-item"><a href="/zh/interview/" class="nav-link">
  面试
</a></div><div class="nav-item"><a href="/zh/DevBasic/" class="nav-link">
  基础
</a></div><div class="nav-item"><a href="/zh/DevAdvance/" class="nav-link router-link-active">
  高级
</a></div><div class="nav-item"><a href="/zh/CloudNative/" class="nav-link">
  云原生
</a></div><div class="nav-item"><a href="/zh/Frontend/" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/zh/Media/" class="nav-link">
  多媒体
</a></div><div class="nav-item"><a href="/zh/DevOthers/" class="nav-link">
  杂谈
</a></div><div class="nav-item"><a href="/zh/article/" class="nav-link">
  文章
</a></div><div class="nav-item"><a href="/zh/about/" class="nav-link">
  关于
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">选择语言</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/" class="nav-link">
  English
</a></li><li class="dropdown-item"><!----> <a href="/zh/DevAdvance/MicroServiceSkill/MQ/RabbitMQ.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  简体中文
</a></li></ul></div></div> <a href="https://github.com/zhengxiaochuan" target="_blank" rel="noopener noreferrer" class="repo-link">
    官网
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/zh/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/zh/guide/" class="nav-link">
  指南
</a></div><div class="nav-item"><a href="/zh/interview/" class="nav-link">
  面试
</a></div><div class="nav-item"><a href="/zh/DevBasic/" class="nav-link">
  基础
</a></div><div class="nav-item"><a href="/zh/DevAdvance/" class="nav-link router-link-active">
  高级
</a></div><div class="nav-item"><a href="/zh/CloudNative/" class="nav-link">
  云原生
</a></div><div class="nav-item"><a href="/zh/Frontend/" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/zh/Media/" class="nav-link">
  多媒体
</a></div><div class="nav-item"><a href="/zh/DevOthers/" class="nav-link">
  杂谈
</a></div><div class="nav-item"><a href="/zh/article/" class="nav-link">
  文章
</a></div><div class="nav-item"><a href="/zh/about/" class="nav-link">
  关于
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">选择语言</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/" class="nav-link">
  English
</a></li><li class="dropdown-item"><!----> <a href="/zh/DevAdvance/MicroServiceSkill/MQ/RabbitMQ.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  简体中文
</a></li></ul></div></div> <a href="https://github.com/zhengxiaochuan" target="_blank" rel="noopener noreferrer" class="repo-link">
    官网
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>SpringBoot基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>SpringBoot整合</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>SpringSecurity</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>编程方法论</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>微服务</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>微服务技术运用</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/zh/DevAdvance/MicroServiceSkill/SpringCloud01/SpringCloud01.html" class="sidebar-link">SpringCloud01</a></li><li><a href="/zh/DevAdvance/MicroServiceSkill/SpringCloud02/SpringCloud实用篇02.html" class="sidebar-link">SpringCloud实用篇02</a></li><li><a href="/zh/DevAdvance/MicroServiceSkill/Docker/Docker实用篇.html" class="sidebar-link">Docker实用篇</a></li><li><a href="/zh/DevAdvance/MicroServiceSkill/Docker/Centos7安装Docker.html" class="sidebar-link">Centos7安装Docker</a></li><li><a href="/zh/DevAdvance/MicroServiceSkill/MQ/RabbitMQ.html" aria-current="page" class="active sidebar-link">RabbitMQ</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/zh/DevAdvance/MicroServiceSkill/MQ/RabbitMQ.html#_1-1-同步和异步通讯" class="sidebar-link">1.1.同步和异步通讯</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/zh/DevAdvance/MicroServiceSkill/MQ/RabbitMQ.html#_1-1-1-同步通讯" class="sidebar-link">1.1.1.同步通讯</a></li><li class="sidebar-sub-header"><a href="/zh/DevAdvance/MicroServiceSkill/MQ/RabbitMQ.html#_1-1-2-异步通讯" class="sidebar-link">1.1.2.异步通讯</a></li></ul></li><li class="sidebar-sub-header"><a href="/zh/DevAdvance/MicroServiceSkill/MQ/RabbitMQ.html#_1-2-技术对比" class="sidebar-link">1.2.技术对比：</a></li><li class="sidebar-sub-header"><a href="/zh/DevAdvance/MicroServiceSkill/MQ/RabbitMQ.html#_2-1-安装rabbitmq" class="sidebar-link">2.1.安装RabbitMQ</a></li><li class="sidebar-sub-header"><a href="/zh/DevAdvance/MicroServiceSkill/MQ/RabbitMQ.html#_2-2-rabbitmq消息模型" class="sidebar-link">2.2.RabbitMQ消息模型</a></li><li class="sidebar-sub-header"><a href="/zh/DevAdvance/MicroServiceSkill/MQ/RabbitMQ.html#_2-3-导入demo工程" class="sidebar-link">2.3.导入Demo工程</a></li><li class="sidebar-sub-header"><a href="/zh/DevAdvance/MicroServiceSkill/MQ/RabbitMQ.html#_2-4-入门案例" class="sidebar-link">2.4.入门案例</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/zh/DevAdvance/MicroServiceSkill/MQ/RabbitMQ.html#_2-4-1-publisher实现" class="sidebar-link">2.4.1.publisher实现</a></li><li class="sidebar-sub-header"><a href="/zh/DevAdvance/MicroServiceSkill/MQ/RabbitMQ.html#_2-4-2-consumer实现" class="sidebar-link">2.4.2.consumer实现</a></li></ul></li><li class="sidebar-sub-header"><a href="/zh/DevAdvance/MicroServiceSkill/MQ/RabbitMQ.html#_2-5-总结" class="sidebar-link">2.5.总结</a></li><li class="sidebar-sub-header"><a href="/zh/DevAdvance/MicroServiceSkill/MQ/RabbitMQ.html#_3-1-basic-queue-简单队列模型" class="sidebar-link">3.1.Basic Queue 简单队列模型</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/zh/DevAdvance/MicroServiceSkill/MQ/RabbitMQ.html#_3-1-1-消息发送" class="sidebar-link">3.1.1.消息发送</a></li><li class="sidebar-sub-header"><a href="/zh/DevAdvance/MicroServiceSkill/MQ/RabbitMQ.html#_3-1-2-消息接收" class="sidebar-link">3.1.2.消息接收</a></li><li class="sidebar-sub-header"><a href="/zh/DevAdvance/MicroServiceSkill/MQ/RabbitMQ.html#_3-1-3-测试" class="sidebar-link">3.1.3.测试</a></li></ul></li><li class="sidebar-sub-header"><a href="/zh/DevAdvance/MicroServiceSkill/MQ/RabbitMQ.html#_3-2-workqueue" class="sidebar-link">3.2.WorkQueue</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/zh/DevAdvance/MicroServiceSkill/MQ/RabbitMQ.html#_3-2-1-消息发送" class="sidebar-link">3.2.1.消息发送</a></li><li class="sidebar-sub-header"><a href="/zh/DevAdvance/MicroServiceSkill/MQ/RabbitMQ.html#_3-2-2-消息接收" class="sidebar-link">3.2.2.消息接收</a></li><li class="sidebar-sub-header"><a href="/zh/DevAdvance/MicroServiceSkill/MQ/RabbitMQ.html#_3-2-3-测试" class="sidebar-link">3.2.3.测试</a></li><li class="sidebar-sub-header"><a href="/zh/DevAdvance/MicroServiceSkill/MQ/RabbitMQ.html#_3-2-4-能者多劳" class="sidebar-link">3.2.4.能者多劳</a></li><li class="sidebar-sub-header"><a href="/zh/DevAdvance/MicroServiceSkill/MQ/RabbitMQ.html#_3-2-5-总结" class="sidebar-link">3.2.5.总结</a></li></ul></li><li class="sidebar-sub-header"><a href="/zh/DevAdvance/MicroServiceSkill/MQ/RabbitMQ.html#_3-3-发布-订阅" class="sidebar-link">3.3.发布/订阅</a></li><li class="sidebar-sub-header"><a href="/zh/DevAdvance/MicroServiceSkill/MQ/RabbitMQ.html#_3-4-fanout" class="sidebar-link">3.4.Fanout</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/zh/DevAdvance/MicroServiceSkill/MQ/RabbitMQ.html#_3-4-1-声明队列和交换机" class="sidebar-link">3.4.1.声明队列和交换机</a></li><li class="sidebar-sub-header"><a href="/zh/DevAdvance/MicroServiceSkill/MQ/RabbitMQ.html#_3-4-2-消息发送" class="sidebar-link">3.4.2.消息发送</a></li><li class="sidebar-sub-header"><a href="/zh/DevAdvance/MicroServiceSkill/MQ/RabbitMQ.html#_3-4-3-消息接收" class="sidebar-link">3.4.3.消息接收</a></li><li class="sidebar-sub-header"><a href="/zh/DevAdvance/MicroServiceSkill/MQ/RabbitMQ.html#_3-4-4-总结" class="sidebar-link">3.4.4.总结</a></li></ul></li><li class="sidebar-sub-header"><a href="/zh/DevAdvance/MicroServiceSkill/MQ/RabbitMQ.html#_3-5-direct" class="sidebar-link">3.5.Direct</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/zh/DevAdvance/MicroServiceSkill/MQ/RabbitMQ.html#_3-5-1-基于注解声明队列和交换机" class="sidebar-link">3.5.1.基于注解声明队列和交换机</a></li><li class="sidebar-sub-header"><a href="/zh/DevAdvance/MicroServiceSkill/MQ/RabbitMQ.html#_3-5-2-消息发送" class="sidebar-link">3.5.2.消息发送</a></li><li class="sidebar-sub-header"><a href="/zh/DevAdvance/MicroServiceSkill/MQ/RabbitMQ.html#_3-5-3-总结" class="sidebar-link">3.5.3.总结</a></li></ul></li><li class="sidebar-sub-header"><a href="/zh/DevAdvance/MicroServiceSkill/MQ/RabbitMQ.html#_3-6-topic" class="sidebar-link">3.6.Topic</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/zh/DevAdvance/MicroServiceSkill/MQ/RabbitMQ.html#_3-6-1-说明" class="sidebar-link">3.6.1.说明</a></li><li class="sidebar-sub-header"><a href="/zh/DevAdvance/MicroServiceSkill/MQ/RabbitMQ.html#_3-6-2-消息发送" class="sidebar-link">3.6.2.消息发送</a></li><li class="sidebar-sub-header"><a href="/zh/DevAdvance/MicroServiceSkill/MQ/RabbitMQ.html#_3-6-3-消息接收" class="sidebar-link">3.6.3.消息接收</a></li><li class="sidebar-sub-header"><a href="/zh/DevAdvance/MicroServiceSkill/MQ/RabbitMQ.html#_3-6-4-总结" class="sidebar-link">3.6.4.总结</a></li></ul></li><li class="sidebar-sub-header"><a href="/zh/DevAdvance/MicroServiceSkill/MQ/RabbitMQ.html#_3-7-消息转换器" class="sidebar-link">3.7.消息转换器</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/zh/DevAdvance/MicroServiceSkill/MQ/RabbitMQ.html#_3-7-1-测试默认转换器" class="sidebar-link">3.7.1.测试默认转换器</a></li><li class="sidebar-sub-header"><a href="/zh/DevAdvance/MicroServiceSkill/MQ/RabbitMQ.html#_3-7-2-配置json转换器" class="sidebar-link">3.7.2.配置JSON转换器</a></li></ul></li></ul></li><li><a href="/zh/DevAdvance/MicroServiceSkill/Elasticsearch01/分布式搜索引擎01.html" class="sidebar-link">分布式搜索引擎01</a></li><li><a href="/zh/DevAdvance/MicroServiceSkill/Elasticsearch02/分布式搜索引擎02.html" class="sidebar-link">分布式搜索引擎02</a></li><li><a href="/zh/DevAdvance/MicroServiceSkill/Elasticsearch03/分布式搜索引擎03.html" class="sidebar-link">分布式搜索引擎03</a></li><li><a href="/zh/DevAdvance/MicroServiceSkill/ElasticsearchInstall/安装Easticsearch.html" class="sidebar-link">安装Elasticsearch</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Docker容器</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Kubernetes</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>解决方案</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="rabbitmq"><a href="#rabbitmq" class="header-anchor">#</a> RabbitMQ</h1> <h1 id="_1-初识mq"><a href="#_1-初识mq" class="header-anchor">#</a> 1.初识MQ</h1> <h2 id="_1-1-同步和异步通讯"><a href="#_1-1-同步和异步通讯" class="header-anchor">#</a> 1.1.同步和异步通讯</h2> <p>微服务间通讯有同步和异步两种方式：</p> <p>同步通讯：就像打电话，需要实时响应。</p> <p>异步通讯：就像发邮件，不需要马上回复。</p> <p><img src="/assets/img/image-20210717161939695.75c5450a.png" alt="image-20210717161939695"></p> <p>两种方式各有优劣，打电话可以立即得到响应，但是你却不能跟多个人同时通话。发送邮件可以同时与多个人收发邮件，但是往往响应会有延迟。</p> <h3 id="_1-1-1-同步通讯"><a href="#_1-1-1-同步通讯" class="header-anchor">#</a> 1.1.1.同步通讯</h3> <p>我们之前学习的Feign调用就属于同步方式，虽然调用可以实时得到结果，但存在下面的问题：</p> <p><img src="/assets/img/image-20210717162004285.675cd6c8.png" alt="image-20210717162004285"></p> <p>总结：</p> <p>同步调用的优点：</p> <ul><li>时效性较强，可以立即得到结果</li></ul> <p>同步调用的问题：</p> <ul><li>耦合度高</li> <li>性能和吞吐能力下降</li> <li>有额外的资源消耗</li> <li>有级联失败问题</li></ul> <h3 id="_1-1-2-异步通讯"><a href="#_1-1-2-异步通讯" class="header-anchor">#</a> 1.1.2.异步通讯</h3> <p>异步调用则可以避免上述问题：</p> <p>我们以购买商品为例，用户支付后需要调用订单服务完成订单状态修改，调用物流服务，从仓库分配响应的库存并准备发货。</p> <p>在事件模式中，支付服务是事件发布者（publisher），在支付完成后只需要发布一个支付成功的事件（event），事件中带上订单id。</p> <p>订单服务和物流服务是事件订阅者（Consumer），订阅支付成功的事件，监听到事件后完成自己业务即可。</p> <p>为了解除事件发布者与订阅者之间的耦合，两者并不是直接通信，而是有一个中间人（Broker）。发布者发布事件到Broker，不关心谁来订阅事件。订阅者从Broker订阅事件，不关心谁发来的消息。</p> <p><img src="/assets/img/image-20210422095356088.2de21ddd.png" alt="image-20210422095356088"></p> <p>Broker 是一个像数据总线一样的东西，所有的服务要接收数据和发送数据都发到这个总线上，这个总线就像协议一样，让服务间的通讯变得标准和可控。</p> <p>好处：</p> <ul><li><p>吞吐量提升：无需等待订阅者处理完成，响应更快速</p></li> <li><p>故障隔离：服务没有直接调用，不存在级联失败问题</p></li> <li><p>调用间没有阻塞，不会造成无效的资源占用</p></li> <li><p>耦合度极低，每个服务都可以灵活插拔，可替换</p></li> <li><p>流量削峰：不管发布事件的流量波动多大，都由Broker接收，订阅者可以按照自己的速度去处理事件</p></li></ul> <p>缺点：</p> <ul><li>架构复杂了，业务没有明显的流程线，不好管理</li> <li>需要依赖于Broker的可靠、安全、性能</li></ul> <p>好在现在开源软件或云平台上 Broker 的软件是非常成熟的，比较常见的一种就是我们今天要学习的MQ技术。</p> <h2 id="_1-2-技术对比"><a href="#_1-2-技术对比" class="header-anchor">#</a> 1.2.技术对比：</h2> <p>MQ，中文是消息队列（MessageQueue），字面来看就是存放消息的队列。也就是事件驱动架构中的Broker。</p> <p>比较常见的MQ实现：</p> <ul><li>ActiveMQ</li> <li>RabbitMQ</li> <li>RocketMQ</li> <li>Kafka</li></ul> <p>几种常见MQ的对比：</p> <table><thead><tr><th></th> <th><strong>RabbitMQ</strong></th> <th><strong>ActiveMQ</strong></th> <th><strong>RocketMQ</strong></th> <th><strong>Kafka</strong></th></tr></thead> <tbody><tr><td>公司/社区</td> <td>Rabbit</td> <td>Apache</td> <td>阿里</td> <td>Apache</td></tr> <tr><td>开发语言</td> <td>Erlang</td> <td>Java</td> <td>Java</td> <td>Scala&amp;Java</td></tr> <tr><td>协议支持</td> <td>AMQP，XMPP，SMTP，STOMP</td> <td>OpenWire,STOMP，REST,XMPP,AMQP</td> <td>自定义协议</td> <td>自定义协议</td></tr> <tr><td>可用性</td> <td>高</td> <td>一般</td> <td>高</td> <td>高</td></tr> <tr><td>单机吞吐量</td> <td>一般</td> <td>差</td> <td>高</td> <td>非常高</td></tr> <tr><td>消息延迟</td> <td>微秒级</td> <td>毫秒级</td> <td>毫秒级</td> <td>毫秒以内</td></tr> <tr><td>消息可靠性</td> <td>高</td> <td>一般</td> <td>高</td> <td>一般</td></tr></tbody></table> <p>追求可用性：Kafka、 RocketMQ 、RabbitMQ</p> <p>追求可靠性：RabbitMQ、RocketMQ</p> <p>追求吞吐能力：RocketMQ、Kafka</p> <p>追求消息低延迟：RabbitMQ、Kafka</p> <h1 id="_2-快速入门"><a href="#_2-快速入门" class="header-anchor">#</a> 2.快速入门</h1> <h2 id="_2-1-安装rabbitmq"><a href="#_2-1-安装rabbitmq" class="header-anchor">#</a> 2.1.安装RabbitMQ</h2> <p>安装RabbitMQ，参考课前资料：</p> <p><img src="assets/image-20210717162628635.png" alt="image-20210717162628635"></p> <p>MQ的基本结构：</p> <p><img src="/assets/img/image-20210717162752376.b00101bd.png" alt="image-20210717162752376"></p> <p>RabbitMQ中的一些角色：</p> <ul><li>publisher：生产者</li> <li>consumer：消费者</li> <li>exchange个：交换机，负责消息路由</li> <li>queue：队列，存储消息</li> <li>virtualHost：虚拟主机，隔离不同租户的exchange、queue、消息的隔离</li></ul> <h2 id="_2-2-rabbitmq消息模型"><a href="#_2-2-rabbitmq消息模型" class="header-anchor">#</a> 2.2.RabbitMQ消息模型</h2> <p>RabbitMQ官方提供了5个不同的Demo示例，对应了不同的消息模型：</p> <p><img src="/assets/img/image-20210717163332646.c1e7fcc8.png" alt="image-20210717163332646"></p> <h2 id="_2-3-导入demo工程"><a href="#_2-3-导入demo工程" class="header-anchor">#</a> 2.3.导入Demo工程</h2> <p>课前资料提供了一个Demo工程，mq-demo:</p> <p><img src="/assets/img/image-20210717163253264.6cd34c58.png" alt="image-20210717163253264"></p> <p>导入后可以看到结构如下：</p> <p><img src="/assets/img/image-20210717163604330.f07729be.png" alt="image-20210717163604330"></p> <p>包括三部分：</p> <ul><li>mq-demo：父工程，管理项目依赖</li> <li>publisher：消息的发送者</li> <li>consumer：消息的消费者</li></ul> <h2 id="_2-4-入门案例"><a href="#_2-4-入门案例" class="header-anchor">#</a> 2.4.入门案例</h2> <p>简单队列模式的模型图：</p> <p><img src="/assets/img/image-20210717163434647.53ccff8c.png" alt="image-20210717163434647"></p> <p>官方的HelloWorld是基于最基础的消息队列模型来实现的，只包括三个角色：</p> <ul><li>publisher：消息发布者，将消息发送到队列queue</li> <li>queue：消息队列，负责接受并缓存消息</li> <li>consumer：订阅队列，处理队列中的消息</li></ul> <h3 id="_2-4-1-publisher实现"><a href="#_2-4-1-publisher实现" class="header-anchor">#</a> 2.4.1.publisher实现</h3> <p>思路：</p> <ul><li>建立连接</li> <li>创建Channel</li> <li>声明队列</li> <li>发送消息</li> <li>关闭连接和channel</li></ul> <p>代码实现：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>mq<span class="token punctuation">.</span>helloworld</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">Channel</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">Connection</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">ConnectionFactory</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span></span><span class="token class-name">Test</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeoutException</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PublisherTest</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testSendMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">TimeoutException</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1.建立连接</span>
        <span class="token class-name">ConnectionFactory</span> factory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConnectionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 1.1.设置连接参数，分别是：主机名、端口号、vhost、用户名、密码</span>
        factory<span class="token punctuation">.</span><span class="token function">setHost</span><span class="token punctuation">(</span><span class="token string">&quot;192.168.150.101&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factory<span class="token punctuation">.</span><span class="token function">setPort</span><span class="token punctuation">(</span><span class="token number">5672</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factory<span class="token punctuation">.</span><span class="token function">setVirtualHost</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factory<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span><span class="token string">&quot;itcast&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factory<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token string">&quot;123321&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 1.2.建立连接</span>
        <span class="token class-name">Connection</span> connection <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">newConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 2.创建通道Channel</span>
        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 3.创建队列</span>
        <span class="token class-name">String</span> queueName <span class="token operator">=</span> <span class="token string">&quot;simple.queue&quot;</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span>queueName<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 4.发送消息</span>
        <span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token string">&quot;hello, rabbitmq!&quot;</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">basicPublish</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> queueName<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> message<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;发送消息成功：【&quot;</span> <span class="token operator">+</span> message <span class="token operator">+</span> <span class="token string">&quot;】&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 5.关闭通道和连接</span>
        channel<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        connection<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><h3 id="_2-4-2-consumer实现"><a href="#_2-4-2-consumer实现" class="header-anchor">#</a> 2.4.2.consumer实现</h3> <p>代码思路：</p> <ul><li>建立连接</li> <li>创建Channel</li> <li>声明队列</li> <li>订阅消息</li></ul> <p>代码实现：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>mq<span class="token punctuation">.</span>helloworld</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeoutException</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConsumerTest</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">TimeoutException</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1.建立连接</span>
        <span class="token class-name">ConnectionFactory</span> factory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConnectionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 1.1.设置连接参数，分别是：主机名、端口号、vhost、用户名、密码</span>
        factory<span class="token punctuation">.</span><span class="token function">setHost</span><span class="token punctuation">(</span><span class="token string">&quot;192.168.150.101&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factory<span class="token punctuation">.</span><span class="token function">setPort</span><span class="token punctuation">(</span><span class="token number">5672</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factory<span class="token punctuation">.</span><span class="token function">setVirtualHost</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factory<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span><span class="token string">&quot;itcast&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factory<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token string">&quot;123321&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 1.2.建立连接</span>
        <span class="token class-name">Connection</span> connection <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">newConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 2.创建通道Channel</span>
        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 3.创建队列</span>
        <span class="token class-name">String</span> queueName <span class="token operator">=</span> <span class="token string">&quot;simple.queue&quot;</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span>queueName<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 4.订阅消息</span>
        channel<span class="token punctuation">.</span><span class="token function">basicConsume</span><span class="token punctuation">(</span>queueName<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">DefaultConsumer</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleDelivery</span><span class="token punctuation">(</span><span class="token class-name">String</span> consumerTag<span class="token punctuation">,</span> <span class="token class-name">Envelope</span> envelope<span class="token punctuation">,</span>
                                       <span class="token class-name">AMQP<span class="token punctuation">.</span>BasicProperties</span> properties<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> body<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
                <span class="token comment">// 5.处理消息</span>
                <span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;接收到消息：【&quot;</span> <span class="token operator">+</span> message <span class="token operator">+</span> <span class="token string">&quot;】&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;等待接收消息。。。。&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><h2 id="_2-5-总结"><a href="#_2-5-总结" class="header-anchor">#</a> 2.5.总结</h2> <p>基本消息队列的消息发送流程：</p> <ol><li><p>建立connection</p></li> <li><p>创建channel</p></li> <li><p>利用channel声明队列</p></li> <li><p>利用channel向队列发送消息</p></li></ol> <p>基本消息队列的消息接收流程：</p> <ol><li><p>建立connection</p></li> <li><p>创建channel</p></li> <li><p>利用channel声明队列</p></li> <li><p>定义consumer的消费行为handleDelivery()</p></li> <li><p>利用channel将消费者与队列绑定</p></li></ol> <h1 id="_3-springamqp"><a href="#_3-springamqp" class="header-anchor">#</a> 3.SpringAMQP</h1> <p>SpringAMQP是基于RabbitMQ封装的一套模板，并且还利用SpringBoot对其实现了自动装配，使用起来非常方便。</p> <p>SpringAmqp的官方地址：https://spring.io/projects/spring-amqp</p> <p><img src="/assets/img/image-20210717164024967.695b4b8d.png" alt="image-20210717164024967"></p> <p><img src="/assets/img/image-20210717164038678.7e69fbeb.png" alt="image-20210717164038678"></p> <p>SpringAMQP提供了三个功能：</p> <ul><li>自动声明队列、交换机及其绑定关系</li> <li>基于注解的监听器模式，异步接收消息</li> <li>封装了RabbitTemplate工具，用于发送消息</li></ul> <h2 id="_3-1-basic-queue-简单队列模型"><a href="#_3-1-basic-queue-简单队列模型" class="header-anchor">#</a> 3.1.Basic Queue 简单队列模型</h2> <p>在父工程mq-demo中引入依赖</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token comment">&lt;!--AMQP依赖，包含RabbitMQ--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-amqp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="_3-1-1-消息发送"><a href="#_3-1-1-消息发送" class="header-anchor">#</a> 3.1.1.消息发送</h3> <p>首先配置MQ地址，在publisher服务的application.yml中添加配置：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">rabbitmq</span><span class="token punctuation">:</span>
    <span class="token key atrule">host</span><span class="token punctuation">:</span> 192.168.150.101 <span class="token comment"># 主机名</span>
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">5672</span> <span class="token comment"># 端口</span>
    <span class="token key atrule">virtual-host</span><span class="token punctuation">:</span> / <span class="token comment"># 虚拟主机</span>
    <span class="token key atrule">username</span><span class="token punctuation">:</span> itcast <span class="token comment"># 用户名</span>
    <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token number">123321</span> <span class="token comment"># 密码</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>然后在publisher服务中编写测试类SpringAmqpTest，并利用RabbitTemplate实现消息发送：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>mq<span class="token punctuation">.</span>spring</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span></span><span class="token class-name">Test</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>runner<span class="token punctuation">.</span></span><span class="token class-name">RunWith</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>rabbit<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">RabbitTemplate</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">SpringBootTest</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span>junit4<span class="token punctuation">.</span></span><span class="token class-name">SpringRunner</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span><span class="token class-name">SpringRunner</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpringAmqpTest</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RabbitTemplate</span> rabbitTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testSimpleQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 队列名称</span>
        <span class="token class-name">String</span> queueName <span class="token operator">=</span> <span class="token string">&quot;simple.queue&quot;</span><span class="token punctuation">;</span>
        <span class="token comment">// 消息</span>
        <span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token string">&quot;hello, spring amqp!&quot;</span><span class="token punctuation">;</span>
        <span class="token comment">// 发送消息</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span>queueName<span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><h3 id="_3-1-2-消息接收"><a href="#_3-1-2-消息接收" class="header-anchor">#</a> 3.1.2.消息接收</h3> <p>首先配置MQ地址，在consumer服务的application.yml中添加配置：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">rabbitmq</span><span class="token punctuation">:</span>
    <span class="token key atrule">host</span><span class="token punctuation">:</span> 192.168.150.101 <span class="token comment"># 主机名</span>
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">5672</span> <span class="token comment"># 端口</span>
    <span class="token key atrule">virtual-host</span><span class="token punctuation">:</span> / <span class="token comment"># 虚拟主机</span>
    <span class="token key atrule">username</span><span class="token punctuation">:</span> itcast <span class="token comment"># 用户名</span>
    <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token number">123321</span> <span class="token comment"># 密码</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>然后在consumer服务的<code>cn.itcast.mq.listener</code>包中新建一个类SpringRabbitListener，代码如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>mq<span class="token punctuation">.</span>listener</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>rabbit<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RabbitListener</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpringRabbitListener</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token string">&quot;simple.queue&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listenSimpleQueueMessage</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;spring 消费者接收到消息：【&quot;</span> <span class="token operator">+</span> msg <span class="token operator">+</span> <span class="token string">&quot;】&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="_3-1-3-测试"><a href="#_3-1-3-测试" class="header-anchor">#</a> 3.1.3.测试</h3> <p>启动consumer服务，然后在publisher服务中运行测试代码，发送MQ消息</p> <h2 id="_3-2-workqueue"><a href="#_3-2-workqueue" class="header-anchor">#</a> 3.2.WorkQueue</h2> <p>Work queues，也被称为（Task queues），任务模型。简单来说就是<strong>让多个消费者绑定到一个队列，共同消费队列中的消息</strong>。</p> <p><img src="/assets/img/image-20210717164238910.aea99599.png" alt="image-20210717164238910"></p> <p>当消息处理比较耗时的时候，可能生产消息的速度会远远大于消息的消费速度。长此以往，消息就会堆积越来越多，无法及时处理。</p> <p>此时就可以使用work 模型，多个消费者共同处理消息处理，速度就能大大提高了。</p> <h3 id="_3-2-1-消息发送"><a href="#_3-2-1-消息发送" class="header-anchor">#</a> 3.2.1.消息发送</h3> <p>这次我们循环发送，模拟大量消息堆积现象。</p> <p>在publisher服务中的SpringAmqpTest类中添加一个测试方法：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
     * workQueue
     * 向队列中不停发送消息，模拟消息堆积。
     */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testWorkQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token comment">// 队列名称</span>
    <span class="token class-name">String</span> queueName <span class="token operator">=</span> <span class="token string">&quot;simple.queue&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">// 消息</span>
    <span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token string">&quot;hello, message_&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">50</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 发送消息</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span>queueName<span class="token punctuation">,</span> message <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h3 id="_3-2-2-消息接收"><a href="#_3-2-2-消息接收" class="header-anchor">#</a> 3.2.2.消息接收</h3> <p>要模拟多个消费者绑定同一个队列，我们在consumer服务的SpringRabbitListener中添加2个新的方法：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token string">&quot;simple.queue&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listenWorkQueue1</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;消费者1接收到消息：【&quot;</span> <span class="token operator">+</span> msg <span class="token operator">+</span> <span class="token string">&quot;】&quot;</span> <span class="token operator">+</span> <span class="token class-name">LocalTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token string">&quot;simple.queue&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listenWorkQueue2</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;消费者2........接收到消息：【&quot;</span> <span class="token operator">+</span> msg <span class="token operator">+</span> <span class="token string">&quot;】&quot;</span> <span class="token operator">+</span> <span class="token class-name">LocalTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>注意到这个消费者sleep了1000秒，模拟任务耗时。</p> <h3 id="_3-2-3-测试"><a href="#_3-2-3-测试" class="header-anchor">#</a> 3.2.3.测试</h3> <p>启动ConsumerApplication后，在执行publisher服务中刚刚编写的发送测试方法testWorkQueue。</p> <p>可以看到消费者1很快完成了自己的25条消息。消费者2却在缓慢的处理自己的25条消息。</p> <p>也就是说消息是平均分配给每个消费者，并没有考虑到消费者的处理能力。这样显然是有问题的。</p> <h3 id="_3-2-4-能者多劳"><a href="#_3-2-4-能者多劳" class="header-anchor">#</a> 3.2.4.能者多劳</h3> <p>在spring中有一个简单的配置，可以解决这个问题。我们修改consumer服务的application.yml文件，添加配置：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">rabbitmq</span><span class="token punctuation">:</span>
    <span class="token key atrule">listener</span><span class="token punctuation">:</span>
      <span class="token key atrule">simple</span><span class="token punctuation">:</span>
        <span class="token key atrule">prefetch</span><span class="token punctuation">:</span> <span class="token number">1</span> <span class="token comment"># 每次只能获取一条消息，处理完成才能获取下一个消息</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="_3-2-5-总结"><a href="#_3-2-5-总结" class="header-anchor">#</a> 3.2.5.总结</h3> <p>Work模型的使用：</p> <ul><li>多个消费者绑定到一个队列，同一条消息只会被一个消费者处理</li> <li>通过设置prefetch来控制消费者预取的消息数量</li></ul> <h2 id="_3-3-发布-订阅"><a href="#_3-3-发布-订阅" class="header-anchor">#</a> 3.3.发布/订阅</h2> <p>发布订阅的模型如图：</p> <p><img src="/assets/img/image-20210717165309625.f97b1e36.png" alt="image-20210717165309625"></p> <p>可以看到，在订阅模型中，多了一个exchange角色，而且过程略有变化：</p> <ul><li>Publisher：生产者，也就是要发送消息的程序，但是不再发送到队列中，而是发给X（交换机）</li> <li>Exchange：交换机，图中的X。一方面，接收生产者发送的消息。另一方面，知道如何处理消息，例如递交给某个特别队列、递交给所有队列、或是将消息丢弃。到底如何操作，取决于Exchange的类型。Exchange有以下3种类型：
<ul><li>Fanout：广播，将消息交给所有绑定到交换机的队列</li> <li>Direct：定向，把消息交给符合指定routing key 的队列</li> <li>Topic：通配符，把消息交给符合routing pattern（路由模式） 的队列</li></ul></li> <li>Consumer：消费者，与以前一样，订阅队列，没有变化</li> <li>Queue：消息队列也与以前一样，接收消息、缓存消息。</li></ul> <p><strong>Exchange（交换机）只负责转发消息，不具备存储消息的能力</strong>，因此如果没有任何队列与Exchange绑定，或者没有符合路由规则的队列，那么消息会丢失！</p> <h2 id="_3-4-fanout"><a href="#_3-4-fanout" class="header-anchor">#</a> 3.4.Fanout</h2> <p>Fanout，英文翻译是扇出，我觉得在MQ中叫广播更合适。</p> <p><img src="/assets/img/image-20210717165438225.dc1debf8.png" alt="image-20210717165438225"></p> <p>在广播模式下，消息发送流程是这样的：</p> <ul><li>1）  可以有多个队列</li> <li>2）  每个队列都要绑定到Exchange（交换机）</li> <li>3）  生产者发送的消息，只能发送到交换机，交换机来决定要发给哪个队列，生产者无法决定</li> <li>4）  交换机把消息发送给绑定过的所有队列</li> <li>5）  订阅队列的消费者都能拿到消息</li></ul> <p>我们的计划是这样的：</p> <ul><li>创建一个交换机 itcast.fanout，类型是Fanout</li> <li>创建两个队列fanout.queue1和fanout.queue2，绑定到交换机itcast.fanout</li></ul> <p><img src="/assets/img/image-20210717165509466.41e56e08.png" alt="image-20210717165509466"></p> <h3 id="_3-4-1-声明队列和交换机"><a href="#_3-4-1-声明队列和交换机" class="header-anchor">#</a> 3.4.1.声明队列和交换机</h3> <p>Spring提供了一个接口Exchange，来表示所有不同类型的交换机：</p> <p><img src="/assets/img/image-20210717165552676.1a27bc7f.png" alt="image-20210717165552676"></p> <p>在consumer中创建一个类，声明队列和交换机：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>mq<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">Binding</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">BindingBuilder</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">FanoutExchange</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">Queue</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FanoutConfig</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 声明交换机
     * @return Fanout类型交换机
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">FanoutExchange</span> <span class="token function">fanoutExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">FanoutExchange</span><span class="token punctuation">(</span><span class="token string">&quot;itcast.fanout&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 第1个队列
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">fanoutQueue1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Queue</span><span class="token punctuation">(</span><span class="token string">&quot;fanout.queue1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 绑定队列和交换机
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">bindingQueue1</span><span class="token punctuation">(</span><span class="token class-name">Queue</span> fanoutQueue1<span class="token punctuation">,</span> <span class="token class-name">FanoutExchange</span> fanoutExchange<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">BindingBuilder</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>fanoutQueue1<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span>fanoutExchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 第2个队列
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">fanoutQueue2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Queue</span><span class="token punctuation">(</span><span class="token string">&quot;fanout.queue2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 绑定队列和交换机
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">bindingQueue2</span><span class="token punctuation">(</span><span class="token class-name">Queue</span> fanoutQueue2<span class="token punctuation">,</span> <span class="token class-name">FanoutExchange</span> fanoutExchange<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">BindingBuilder</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>fanoutQueue2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span>fanoutExchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br></div></div><h3 id="_3-4-2-消息发送"><a href="#_3-4-2-消息发送" class="header-anchor">#</a> 3.4.2.消息发送</h3> <p>在publisher服务的SpringAmqpTest类中添加测试方法：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testFanoutExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 队列名称</span>
    <span class="token class-name">String</span> exchangeName <span class="token operator">=</span> <span class="token string">&quot;itcast.fanout&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">// 消息</span>
    <span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token string">&quot;hello, everyone!&quot;</span><span class="token punctuation">;</span>
    rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span>exchangeName<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="_3-4-3-消息接收"><a href="#_3-4-3-消息接收" class="header-anchor">#</a> 3.4.3.消息接收</h3> <p>在consumer服务的SpringRabbitListener中添加两个方法，作为消费者：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token string">&quot;fanout.queue1&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listenFanoutQueue1</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;消费者1接收到Fanout消息：【&quot;</span> <span class="token operator">+</span> msg <span class="token operator">+</span> <span class="token string">&quot;】&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token string">&quot;fanout.queue2&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listenFanoutQueue2</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;消费者2接收到Fanout消息：【&quot;</span> <span class="token operator">+</span> msg <span class="token operator">+</span> <span class="token string">&quot;】&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="_3-4-4-总结"><a href="#_3-4-4-总结" class="header-anchor">#</a> 3.4.4.总结</h3> <p>交换机的作用是什么？</p> <ul><li>接收publisher发送的消息</li> <li>将消息按照规则路由到与之绑定的队列</li> <li>不能缓存消息，路由失败，消息丢失</li> <li>FanoutExchange的会将消息路由到每个绑定的队列</li></ul> <p>声明队列、交换机、绑定关系的Bean是什么？</p> <ul><li>Queue</li> <li>FanoutExchange</li> <li>Binding</li></ul> <h2 id="_3-5-direct"><a href="#_3-5-direct" class="header-anchor">#</a> 3.5.Direct</h2> <p>在Fanout模式中，一条消息，会被所有订阅的队列都消费。但是，在某些场景下，我们希望不同的消息被不同的队列消费。这时就要用到Direct类型的Exchange。</p> <p><img src="/assets/img/image-20210717170041447.262a1ae2.png" alt="image-20210717170041447"></p> <p>在Direct模型下：</p> <ul><li>队列与交换机的绑定，不能是任意绑定了，而是要指定一个<code>RoutingKey</code>（路由key）</li> <li>消息的发送方在 向 Exchange发送消息时，也必须指定消息的 <code>RoutingKey</code>。</li> <li>Exchange不再把消息交给每一个绑定的队列，而是根据消息的<code>Routing Key</code>进行判断，只有队列的<code>Routingkey</code>与消息的 <code>Routing key</code>完全一致，才会接收到消息</li></ul> <p><strong>案例需求如下</strong>：</p> <ol><li><p>利用@RabbitListener声明Exchange、Queue、RoutingKey</p></li> <li><p>在consumer服务中，编写两个消费者方法，分别监听direct.queue1和direct.queue2</p></li> <li><p>在publisher中编写测试方法，向itcast. direct发送消息</p></li></ol> <p><img src="/assets/img/image-20210717170223317.c3f75593.png" alt="image-20210717170223317"></p> <h3 id="_3-5-1-基于注解声明队列和交换机"><a href="#_3-5-1-基于注解声明队列和交换机" class="header-anchor">#</a> 3.5.1.基于注解声明队列和交换机</h3> <p>基于@Bean的方式声明队列和交换机比较麻烦，Spring还提供了基于注解方式来声明。</p> <p>在consumer的SpringRabbitListener中添加两个消费者，同时基于注解来声明队列和交换机：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>bindings <span class="token operator">=</span> <span class="token annotation punctuation">@QueueBinding</span><span class="token punctuation">(</span>
    value <span class="token operator">=</span> <span class="token annotation punctuation">@Queue</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;direct.queue1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    exchange <span class="token operator">=</span> <span class="token annotation punctuation">@Exchange</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;itcast.direct&quot;</span><span class="token punctuation">,</span> type <span class="token operator">=</span> <span class="token class-name">ExchangeTypes</span><span class="token punctuation">.</span>DIRECT<span class="token punctuation">)</span><span class="token punctuation">,</span>
    key <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;red&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;blue&quot;</span><span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listenDirectQueue1</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;消费者接收到direct.queue1的消息：【&quot;</span> <span class="token operator">+</span> msg <span class="token operator">+</span> <span class="token string">&quot;】&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>bindings <span class="token operator">=</span> <span class="token annotation punctuation">@QueueBinding</span><span class="token punctuation">(</span>
    value <span class="token operator">=</span> <span class="token annotation punctuation">@Queue</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;direct.queue2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    exchange <span class="token operator">=</span> <span class="token annotation punctuation">@Exchange</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;itcast.direct&quot;</span><span class="token punctuation">,</span> type <span class="token operator">=</span> <span class="token class-name">ExchangeTypes</span><span class="token punctuation">.</span>DIRECT<span class="token punctuation">)</span><span class="token punctuation">,</span>
    key <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;red&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;yellow&quot;</span><span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listenDirectQueue2</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;消费者接收到direct.queue2的消息：【&quot;</span> <span class="token operator">+</span> msg <span class="token operator">+</span> <span class="token string">&quot;】&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h3 id="_3-5-2-消息发送"><a href="#_3-5-2-消息发送" class="header-anchor">#</a> 3.5.2.消息发送</h3> <p>在publisher服务的SpringAmqpTest类中添加测试方法：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testSendDirectExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 交换机名称</span>
    <span class="token class-name">String</span> exchangeName <span class="token operator">=</span> <span class="token string">&quot;itcast.direct&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">// 消息</span>
    <span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token string">&quot;红色警报！日本乱排核废水，导致海洋生物变异，惊现哥斯拉！&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">// 发送消息</span>
    rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span>exchangeName<span class="token punctuation">,</span> <span class="token string">&quot;red&quot;</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="_3-5-3-总结"><a href="#_3-5-3-总结" class="header-anchor">#</a> 3.5.3.总结</h3> <p>描述下Direct交换机与Fanout交换机的差异？</p> <ul><li>Fanout交换机将消息路由给每一个与之绑定的队列</li> <li>Direct交换机根据RoutingKey判断路由给哪个队列</li> <li>如果多个队列具有相同的RoutingKey，则与Fanout功能类似</li></ul> <p>基于@RabbitListener注解声明队列和交换机有哪些常见注解？</p> <ul><li>@Queue</li> <li>@Exchange</li></ul> <h2 id="_3-6-topic"><a href="#_3-6-topic" class="header-anchor">#</a> 3.6.Topic</h2> <h3 id="_3-6-1-说明"><a href="#_3-6-1-说明" class="header-anchor">#</a> 3.6.1.说明</h3> <p><code>Topic</code>类型的<code>Exchange</code>与<code>Direct</code>相比，都是可以根据<code>RoutingKey</code>把消息路由到不同的队列。只不过<code>Topic</code>类型<code>Exchange</code>可以让队列在绑定<code>Routing key</code> 的时候使用通配符！</p> <p><code>Routingkey</code> 一般都是有一个或多个单词组成，多个单词之间以”.”分割，例如： <code>item.insert</code></p> <p>通配符规则：</p> <p><code>#</code>：匹配一个或多个词</p> <p><code>*</code>：匹配不多不少恰好1个词</p> <p>举例：</p> <p><code>item.#</code>：能够匹配<code>item.spu.insert</code> 或者 <code>item.spu</code></p> <p><code>item.*</code>：只能匹配<code>item.spu</code></p> <p>​</p> <p>图示：</p> <p><img src="/assets/img/image-20210717170705380.f8bc75f6.png" alt="image-20210717170705380"></p> <p>解释：</p> <ul><li>Queue1：绑定的是<code>china.#</code> ，因此凡是以 <code>china.</code>开头的<code>routing key</code> 都会被匹配到。包括china.news和china.weather</li> <li>Queue2：绑定的是<code>#.news</code> ，因此凡是以 <code>.news</code>结尾的 <code>routing key</code> 都会被匹配。包括china.news和japan.news</li></ul> <p>案例需求：</p> <p>实现思路如下：</p> <ol><li><p>并利用@RabbitListener声明Exchange、Queue、RoutingKey</p></li> <li><p>在consumer服务中，编写两个消费者方法，分别监听topic.queue1和topic.queue2</p></li> <li><p>在publisher中编写测试方法，向itcast. topic发送消息</p></li></ol> <p><img src="/assets/img/image-20210717170829229.2fa54688.png" alt="image-20210717170829229"></p> <h3 id="_3-6-2-消息发送"><a href="#_3-6-2-消息发送" class="header-anchor">#</a> 3.6.2.消息发送</h3> <p>在publisher服务的SpringAmqpTest类中添加测试方法：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
     * topicExchange
     */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testSendTopicExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 交换机名称</span>
    <span class="token class-name">String</span> exchangeName <span class="token operator">=</span> <span class="token string">&quot;itcast.topic&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">// 消息</span>
    <span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token string">&quot;喜报！孙悟空大战哥斯拉，胜!&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">// 发送消息</span>
    rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span>exchangeName<span class="token punctuation">,</span> <span class="token string">&quot;china.news&quot;</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h3 id="_3-6-3-消息接收"><a href="#_3-6-3-消息接收" class="header-anchor">#</a> 3.6.3.消息接收</h3> <p>在consumer服务的SpringRabbitListener中添加方法：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>bindings <span class="token operator">=</span> <span class="token annotation punctuation">@QueueBinding</span><span class="token punctuation">(</span>
    value <span class="token operator">=</span> <span class="token annotation punctuation">@Queue</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;topic.queue1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    exchange <span class="token operator">=</span> <span class="token annotation punctuation">@Exchange</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;itcast.topic&quot;</span><span class="token punctuation">,</span> type <span class="token operator">=</span> <span class="token class-name">ExchangeTypes</span><span class="token punctuation">.</span>TOPIC<span class="token punctuation">)</span><span class="token punctuation">,</span>
    key <span class="token operator">=</span> <span class="token string">&quot;china.#&quot;</span>
<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listenTopicQueue1</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;消费者接收到topic.queue1的消息：【&quot;</span> <span class="token operator">+</span> msg <span class="token operator">+</span> <span class="token string">&quot;】&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>bindings <span class="token operator">=</span> <span class="token annotation punctuation">@QueueBinding</span><span class="token punctuation">(</span>
    value <span class="token operator">=</span> <span class="token annotation punctuation">@Queue</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;topic.queue2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    exchange <span class="token operator">=</span> <span class="token annotation punctuation">@Exchange</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;itcast.topic&quot;</span><span class="token punctuation">,</span> type <span class="token operator">=</span> <span class="token class-name">ExchangeTypes</span><span class="token punctuation">.</span>TOPIC<span class="token punctuation">)</span><span class="token punctuation">,</span>
    key <span class="token operator">=</span> <span class="token string">&quot;#.news&quot;</span>
<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listenTopicQueue2</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;消费者接收到topic.queue2的消息：【&quot;</span> <span class="token operator">+</span> msg <span class="token operator">+</span> <span class="token string">&quot;】&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h3 id="_3-6-4-总结"><a href="#_3-6-4-总结" class="header-anchor">#</a> 3.6.4.总结</h3> <p>描述下Direct交换机与Topic交换机的差异？</p> <ul><li>Topic交换机接收的消息RoutingKey必须是多个单词，以 <code>**.**</code> 分割</li> <li>Topic交换机与队列绑定时的bindingKey可以指定通配符</li> <li><code>#</code>：代表0个或多个词</li> <li><code>*</code>：代表1个词</li></ul> <h2 id="_3-7-消息转换器"><a href="#_3-7-消息转换器" class="header-anchor">#</a> 3.7.消息转换器</h2> <p>之前说过，Spring会把你发送的消息序列化为字节发送给MQ，接收消息的时候，还会把字节反序列化为Java对象。</p> <p><img src="/assets/img/image-20200525170410401.68eb220c.png" alt="image-20200525170410401"></p> <p>只不过，默认情况下Spring采用的序列化方式是JDK序列化。众所周知，JDK序列化存在下列问题：</p> <ul><li>数据体积过大</li> <li>有安全漏洞</li> <li>可读性差</li></ul> <p>我们来测试一下。</p> <h3 id="_3-7-1-测试默认转换器"><a href="#_3-7-1-测试默认转换器" class="header-anchor">#</a> 3.7.1.测试默认转换器</h3> <p>我们修改消息发送的代码，发送一个Map对象：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testSendMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token comment">// 准备消息</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    msg<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Jack&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    msg<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 发送消息</span>
    rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">&quot;simple.queue&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>停止consumer服务</p> <p>发送消息后查看控制台：</p> <p><img src="/assets/img/image-20210422232835363.38e2d259.png" alt="image-20210422232835363"></p> <h3 id="_3-7-2-配置json转换器"><a href="#_3-7-2-配置json转换器" class="header-anchor">#</a> 3.7.2.配置JSON转换器</h3> <p>显然，JDK序列化方式并不合适。我们希望消息体的体积更小、可读性更高，因此可以使用JSON方式来做序列化和反序列化。</p> <p>在publisher和consumer两个服务中都引入依赖：</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.fasterxml.jackson.dataformat<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jackson-dataformat-xml<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.9.10<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>配置消息转换器。</p> <p>在启动类中添加一个Bean即可：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">MessageConverter</span> <span class="token function">jsonMessageConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Jackson2JsonMessageConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2021/8/26 下午1:33:55</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/zh/DevAdvance/MicroServiceSkill/Docker/Centos7安装Docker.html" class="prev">
        Centos7安装Docker
      </a></span> <span class="next"><a href="/zh/DevAdvance/MicroServiceSkill/Elasticsearch01/分布式搜索引擎01.html">
        分布式搜索引擎01
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.318be929.js" defer></script><script src="/assets/js/5.120864d5.js" defer></script><script src="/assets/js/17.103a3d21.js" defer></script>
  </body>
</html>
