<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>10-整合SpringSecurity实现权限注解+JWT登录认证 | 狸猫小僧</title>
    <meta name="generator" content="VuePress 1.8.3">
    <link rel="icon" href="/favicon.ico">
    <link rel="manifest" href="/manifest.json">
    <meta name="description" content="记录点滴足迹  保留美好时光">
    
    <link rel="preload" href="/assets/css/0.styles.89e32c3d.css" as="style"><link rel="preload" href="/assets/js/app.fd7d1168.js" as="script"><link rel="preload" href="/assets/js/5.8188c8a3.js" as="script"><link rel="preload" href="/assets/js/61.a135170d.js" as="script"><link rel="prefetch" href="/assets/js/10.5efc25fb.js"><link rel="prefetch" href="/assets/js/100.2365220c.js"><link rel="prefetch" href="/assets/js/101.7dc95f84.js"><link rel="prefetch" href="/assets/js/102.668abbc6.js"><link rel="prefetch" href="/assets/js/103.4711787a.js"><link rel="prefetch" href="/assets/js/104.9c31f74c.js"><link rel="prefetch" href="/assets/js/105.eae619f3.js"><link rel="prefetch" href="/assets/js/106.91fadf69.js"><link rel="prefetch" href="/assets/js/107.df2c7348.js"><link rel="prefetch" href="/assets/js/108.a8a3a823.js"><link rel="prefetch" href="/assets/js/109.af72ccbe.js"><link rel="prefetch" href="/assets/js/11.5daa4268.js"><link rel="prefetch" href="/assets/js/110.5e268b5f.js"><link rel="prefetch" href="/assets/js/111.b1fc7cda.js"><link rel="prefetch" href="/assets/js/112.ef44a073.js"><link rel="prefetch" href="/assets/js/113.6fe9aa70.js"><link rel="prefetch" href="/assets/js/114.08728c80.js"><link rel="prefetch" href="/assets/js/115.3889b46f.js"><link rel="prefetch" href="/assets/js/116.3fc5af23.js"><link rel="prefetch" href="/assets/js/117.6813af12.js"><link rel="prefetch" href="/assets/js/118.f082dcb3.js"><link rel="prefetch" href="/assets/js/119.ae3e4d3b.js"><link rel="prefetch" href="/assets/js/12.3a02d4dc.js"><link rel="prefetch" href="/assets/js/120.febf0262.js"><link rel="prefetch" href="/assets/js/121.991c7b25.js"><link rel="prefetch" href="/assets/js/122.8bb46ec5.js"><link rel="prefetch" href="/assets/js/123.dc209fc9.js"><link rel="prefetch" href="/assets/js/124.0337013a.js"><link rel="prefetch" href="/assets/js/125.4cc003c8.js"><link rel="prefetch" href="/assets/js/126.24d4de8e.js"><link rel="prefetch" href="/assets/js/127.060b364e.js"><link rel="prefetch" href="/assets/js/128.eecf8a8d.js"><link rel="prefetch" href="/assets/js/129.2c476cfc.js"><link rel="prefetch" href="/assets/js/13.86c9671d.js"><link rel="prefetch" href="/assets/js/130.74773727.js"><link rel="prefetch" href="/assets/js/131.0d2c7e45.js"><link rel="prefetch" href="/assets/js/132.3983b867.js"><link rel="prefetch" href="/assets/js/133.563acb6a.js"><link rel="prefetch" href="/assets/js/134.d5e19b37.js"><link rel="prefetch" href="/assets/js/135.9079aab2.js"><link rel="prefetch" href="/assets/js/136.e43d5956.js"><link rel="prefetch" href="/assets/js/137.32a9c7ad.js"><link rel="prefetch" href="/assets/js/138.3163c2ac.js"><link rel="prefetch" href="/assets/js/139.c19c678c.js"><link rel="prefetch" href="/assets/js/14.3fa80602.js"><link rel="prefetch" href="/assets/js/140.cb7bf08b.js"><link rel="prefetch" href="/assets/js/141.d282ed08.js"><link rel="prefetch" href="/assets/js/142.60fb950b.js"><link rel="prefetch" href="/assets/js/143.c7fa8a77.js"><link rel="prefetch" href="/assets/js/144.0ac55427.js"><link rel="prefetch" href="/assets/js/145.e7dca70c.js"><link rel="prefetch" href="/assets/js/146.e5c89bf1.js"><link rel="prefetch" href="/assets/js/147.ad8702e4.js"><link rel="prefetch" href="/assets/js/148.f2131fa6.js"><link rel="prefetch" href="/assets/js/149.950a6c8a.js"><link rel="prefetch" href="/assets/js/15.608f6176.js"><link rel="prefetch" href="/assets/js/150.d2265821.js"><link rel="prefetch" href="/assets/js/151.9cedca96.js"><link rel="prefetch" href="/assets/js/152.0b9d1ef6.js"><link rel="prefetch" href="/assets/js/153.88011a76.js"><link rel="prefetch" href="/assets/js/154.424b16d1.js"><link rel="prefetch" href="/assets/js/155.b2899f2d.js"><link rel="prefetch" href="/assets/js/156.a8d8aa97.js"><link rel="prefetch" href="/assets/js/157.fb21de37.js"><link rel="prefetch" href="/assets/js/158.07429d07.js"><link rel="prefetch" href="/assets/js/159.bf1a56e4.js"><link rel="prefetch" href="/assets/js/16.dba563e1.js"><link rel="prefetch" href="/assets/js/160.cf6233e1.js"><link rel="prefetch" href="/assets/js/161.30f5ff81.js"><link rel="prefetch" href="/assets/js/162.471a5fc5.js"><link rel="prefetch" href="/assets/js/163.47bfac71.js"><link rel="prefetch" href="/assets/js/164.b6e9f622.js"><link rel="prefetch" href="/assets/js/165.9064fa22.js"><link rel="prefetch" href="/assets/js/166.55cfc286.js"><link rel="prefetch" href="/assets/js/167.6e461517.js"><link rel="prefetch" href="/assets/js/168.c8ffaeac.js"><link rel="prefetch" href="/assets/js/169.07bff66e.js"><link rel="prefetch" href="/assets/js/17.99c724e6.js"><link rel="prefetch" href="/assets/js/170.0c2ccae0.js"><link rel="prefetch" href="/assets/js/171.c2764740.js"><link rel="prefetch" href="/assets/js/172.466bd875.js"><link rel="prefetch" href="/assets/js/173.b698c502.js"><link rel="prefetch" href="/assets/js/174.8cb5165a.js"><link rel="prefetch" href="/assets/js/175.43e2e98e.js"><link rel="prefetch" href="/assets/js/176.30f5ec79.js"><link rel="prefetch" href="/assets/js/177.41e9f5b7.js"><link rel="prefetch" href="/assets/js/178.626a00c9.js"><link rel="prefetch" href="/assets/js/179.ec1f02ee.js"><link rel="prefetch" href="/assets/js/18.a465d68f.js"><link rel="prefetch" href="/assets/js/180.ef1eb477.js"><link rel="prefetch" href="/assets/js/181.2c9bc20e.js"><link rel="prefetch" href="/assets/js/182.5c317e34.js"><link rel="prefetch" href="/assets/js/183.3735c423.js"><link rel="prefetch" href="/assets/js/184.7954fbf0.js"><link rel="prefetch" href="/assets/js/185.14882539.js"><link rel="prefetch" href="/assets/js/186.ebcc2c13.js"><link rel="prefetch" href="/assets/js/187.1885217e.js"><link rel="prefetch" href="/assets/js/188.2a281c2d.js"><link rel="prefetch" href="/assets/js/189.f3a4b5fa.js"><link rel="prefetch" href="/assets/js/19.9f30faef.js"><link rel="prefetch" href="/assets/js/190.4df3822c.js"><link rel="prefetch" href="/assets/js/191.fcb3f7b2.js"><link rel="prefetch" href="/assets/js/192.410dad49.js"><link rel="prefetch" href="/assets/js/193.69116851.js"><link rel="prefetch" href="/assets/js/194.3ed49967.js"><link rel="prefetch" href="/assets/js/195.6f61bba3.js"><link rel="prefetch" href="/assets/js/196.8f6e25a7.js"><link rel="prefetch" href="/assets/js/197.000d9666.js"><link rel="prefetch" href="/assets/js/198.2473b124.js"><link rel="prefetch" href="/assets/js/199.550727a1.js"><link rel="prefetch" href="/assets/js/20.35fbb8b5.js"><link rel="prefetch" href="/assets/js/200.1978994f.js"><link rel="prefetch" href="/assets/js/201.6377ffcd.js"><link rel="prefetch" href="/assets/js/202.3888d5b7.js"><link rel="prefetch" href="/assets/js/203.27b6370e.js"><link rel="prefetch" href="/assets/js/204.339588e3.js"><link rel="prefetch" href="/assets/js/205.3ca7975e.js"><link rel="prefetch" href="/assets/js/206.154ce927.js"><link rel="prefetch" href="/assets/js/207.ae015e56.js"><link rel="prefetch" href="/assets/js/208.0ac1810b.js"><link rel="prefetch" href="/assets/js/209.95e81b11.js"><link rel="prefetch" href="/assets/js/21.5a3c8cda.js"><link rel="prefetch" href="/assets/js/210.530259e0.js"><link rel="prefetch" href="/assets/js/211.7d3b4f86.js"><link rel="prefetch" href="/assets/js/212.c2bbbf97.js"><link rel="prefetch" href="/assets/js/213.e57701e4.js"><link rel="prefetch" href="/assets/js/214.13083434.js"><link rel="prefetch" href="/assets/js/215.50bac1a7.js"><link rel="prefetch" href="/assets/js/216.de8db778.js"><link rel="prefetch" href="/assets/js/217.b0783229.js"><link rel="prefetch" href="/assets/js/218.33317dc4.js"><link rel="prefetch" href="/assets/js/219.7a51ea2c.js"><link rel="prefetch" href="/assets/js/22.f7900f46.js"><link rel="prefetch" href="/assets/js/220.b34df14d.js"><link rel="prefetch" href="/assets/js/221.7d1fac29.js"><link rel="prefetch" href="/assets/js/222.8f3a8c90.js"><link rel="prefetch" href="/assets/js/223.c5443f55.js"><link rel="prefetch" href="/assets/js/224.fd1e776f.js"><link rel="prefetch" href="/assets/js/225.32036420.js"><link rel="prefetch" href="/assets/js/226.72b07dee.js"><link rel="prefetch" href="/assets/js/227.61a3b305.js"><link rel="prefetch" href="/assets/js/228.3fd39553.js"><link rel="prefetch" href="/assets/js/229.0eb71bb4.js"><link rel="prefetch" href="/assets/js/23.76e85425.js"><link rel="prefetch" href="/assets/js/230.d2fd9461.js"><link rel="prefetch" href="/assets/js/231.8f2b1878.js"><link rel="prefetch" href="/assets/js/232.c74d3cfd.js"><link rel="prefetch" href="/assets/js/233.ca68325f.js"><link rel="prefetch" href="/assets/js/234.b7021eb7.js"><link rel="prefetch" href="/assets/js/235.5fbbe5a8.js"><link rel="prefetch" href="/assets/js/236.09faaa4a.js"><link rel="prefetch" href="/assets/js/237.c4c27b11.js"><link rel="prefetch" href="/assets/js/238.f2379661.js"><link rel="prefetch" href="/assets/js/239.2a2ffd3e.js"><link rel="prefetch" href="/assets/js/24.8abae6d7.js"><link rel="prefetch" href="/assets/js/240.614b1aea.js"><link rel="prefetch" href="/assets/js/241.d43daf1d.js"><link rel="prefetch" href="/assets/js/242.b2a2c494.js"><link rel="prefetch" href="/assets/js/243.103b4b75.js"><link rel="prefetch" href="/assets/js/244.a5cf1546.js"><link rel="prefetch" href="/assets/js/245.3473d532.js"><link rel="prefetch" href="/assets/js/246.4e490c6f.js"><link rel="prefetch" href="/assets/js/247.1273ff7b.js"><link rel="prefetch" href="/assets/js/248.fb1b51c6.js"><link rel="prefetch" href="/assets/js/249.131e1f43.js"><link rel="prefetch" href="/assets/js/25.cd40fdc6.js"><link rel="prefetch" href="/assets/js/250.9d5a6ea9.js"><link rel="prefetch" href="/assets/js/251.06a49f61.js"><link rel="prefetch" href="/assets/js/252.8c317cd1.js"><link rel="prefetch" href="/assets/js/253.ba7e2ae2.js"><link rel="prefetch" href="/assets/js/254.41d51d7c.js"><link rel="prefetch" href="/assets/js/255.fdb2d893.js"><link rel="prefetch" href="/assets/js/256.7d965f53.js"><link rel="prefetch" href="/assets/js/257.de36c834.js"><link rel="prefetch" href="/assets/js/258.76d744b3.js"><link rel="prefetch" href="/assets/js/259.d32c111f.js"><link rel="prefetch" href="/assets/js/26.1a1717f0.js"><link rel="prefetch" href="/assets/js/260.725aa988.js"><link rel="prefetch" href="/assets/js/261.0113a3db.js"><link rel="prefetch" href="/assets/js/262.4ba80064.js"><link rel="prefetch" href="/assets/js/263.bf55c723.js"><link rel="prefetch" href="/assets/js/264.8ed99bc0.js"><link rel="prefetch" href="/assets/js/265.3231df29.js"><link rel="prefetch" href="/assets/js/266.a66b8d5f.js"><link rel="prefetch" href="/assets/js/267.de7744c9.js"><link rel="prefetch" href="/assets/js/268.cf69ef86.js"><link rel="prefetch" href="/assets/js/269.83de3918.js"><link rel="prefetch" href="/assets/js/27.7c945152.js"><link rel="prefetch" href="/assets/js/270.6abb67d4.js"><link rel="prefetch" href="/assets/js/271.ef79848f.js"><link rel="prefetch" href="/assets/js/272.c3a8f537.js"><link rel="prefetch" href="/assets/js/273.9f06c48f.js"><link rel="prefetch" href="/assets/js/274.5589933d.js"><link rel="prefetch" href="/assets/js/275.731bc5b7.js"><link rel="prefetch" href="/assets/js/276.28040273.js"><link rel="prefetch" href="/assets/js/277.bb360099.js"><link rel="prefetch" href="/assets/js/278.ab1ffdb2.js"><link rel="prefetch" href="/assets/js/279.760b345e.js"><link rel="prefetch" href="/assets/js/28.1424aae1.js"><link rel="prefetch" href="/assets/js/280.51770d82.js"><link rel="prefetch" href="/assets/js/281.1d79fec6.js"><link rel="prefetch" href="/assets/js/282.7691378f.js"><link rel="prefetch" href="/assets/js/283.2a209993.js"><link rel="prefetch" href="/assets/js/284.d85be3fc.js"><link rel="prefetch" href="/assets/js/285.f8dfd0b3.js"><link rel="prefetch" href="/assets/js/286.816c2136.js"><link rel="prefetch" href="/assets/js/287.b999d89f.js"><link rel="prefetch" href="/assets/js/288.b20f933e.js"><link rel="prefetch" href="/assets/js/289.9e35f6a0.js"><link rel="prefetch" href="/assets/js/29.4c235136.js"><link rel="prefetch" href="/assets/js/290.20c9f2db.js"><link rel="prefetch" href="/assets/js/291.7da9a608.js"><link rel="prefetch" href="/assets/js/292.dca1caeb.js"><link rel="prefetch" href="/assets/js/293.8c24c009.js"><link rel="prefetch" href="/assets/js/294.2abdc3db.js"><link rel="prefetch" href="/assets/js/295.d6a3adad.js"><link rel="prefetch" href="/assets/js/296.2adaff35.js"><link rel="prefetch" href="/assets/js/297.5e978c4a.js"><link rel="prefetch" href="/assets/js/298.8069001c.js"><link rel="prefetch" href="/assets/js/299.34e63889.js"><link rel="prefetch" href="/assets/js/3.70395677.js"><link rel="prefetch" href="/assets/js/30.a38b3c0c.js"><link rel="prefetch" href="/assets/js/300.31f8aaf6.js"><link rel="prefetch" href="/assets/js/301.f7203d80.js"><link rel="prefetch" href="/assets/js/302.b3d80be5.js"><link rel="prefetch" href="/assets/js/303.7a857ce2.js"><link rel="prefetch" href="/assets/js/304.f90d83b5.js"><link rel="prefetch" href="/assets/js/305.fa61808c.js"><link rel="prefetch" href="/assets/js/306.05a2581c.js"><link rel="prefetch" href="/assets/js/307.fef2c80f.js"><link rel="prefetch" href="/assets/js/308.c60ae19d.js"><link rel="prefetch" href="/assets/js/309.9c6cdeb9.js"><link rel="prefetch" href="/assets/js/31.8a3e8cc0.js"><link rel="prefetch" href="/assets/js/310.6286a1b4.js"><link rel="prefetch" href="/assets/js/311.12348d9f.js"><link rel="prefetch" href="/assets/js/312.9264fa0d.js"><link rel="prefetch" href="/assets/js/313.ddba82b5.js"><link rel="prefetch" href="/assets/js/314.ae38627f.js"><link rel="prefetch" href="/assets/js/315.f828e73e.js"><link rel="prefetch" href="/assets/js/316.119ada3f.js"><link rel="prefetch" href="/assets/js/317.ba2ede70.js"><link rel="prefetch" href="/assets/js/318.0d3e1bab.js"><link rel="prefetch" href="/assets/js/319.d060df8b.js"><link rel="prefetch" href="/assets/js/32.41f36fdb.js"><link rel="prefetch" href="/assets/js/320.2f61a3ed.js"><link rel="prefetch" href="/assets/js/321.7bcb6e4e.js"><link rel="prefetch" href="/assets/js/322.3c8c2b63.js"><link rel="prefetch" href="/assets/js/323.5521c9d0.js"><link rel="prefetch" href="/assets/js/324.8437d6ad.js"><link rel="prefetch" href="/assets/js/325.2bef158e.js"><link rel="prefetch" href="/assets/js/326.10f510da.js"><link rel="prefetch" href="/assets/js/327.e162cc9b.js"><link rel="prefetch" href="/assets/js/328.2b06d94a.js"><link rel="prefetch" href="/assets/js/329.561f32eb.js"><link rel="prefetch" href="/assets/js/33.55ef9183.js"><link rel="prefetch" href="/assets/js/330.e802dbbd.js"><link rel="prefetch" href="/assets/js/331.88ba6528.js"><link rel="prefetch" href="/assets/js/332.349431e9.js"><link rel="prefetch" href="/assets/js/333.31d0d56d.js"><link rel="prefetch" href="/assets/js/334.763ceda4.js"><link rel="prefetch" href="/assets/js/335.17a450df.js"><link rel="prefetch" href="/assets/js/336.6e99a6c4.js"><link rel="prefetch" href="/assets/js/337.7300a8a1.js"><link rel="prefetch" href="/assets/js/338.8c4badb1.js"><link rel="prefetch" href="/assets/js/339.ce2817fb.js"><link rel="prefetch" href="/assets/js/34.8c034219.js"><link rel="prefetch" href="/assets/js/340.9334b73a.js"><link rel="prefetch" href="/assets/js/341.99e5ae47.js"><link rel="prefetch" href="/assets/js/342.e12e4706.js"><link rel="prefetch" href="/assets/js/343.bfc6b8fb.js"><link rel="prefetch" href="/assets/js/344.461f2dd0.js"><link rel="prefetch" href="/assets/js/345.ec6ee553.js"><link rel="prefetch" href="/assets/js/346.9fcdd8f2.js"><link rel="prefetch" href="/assets/js/347.55f7e455.js"><link rel="prefetch" href="/assets/js/348.fd77ba8d.js"><link rel="prefetch" href="/assets/js/349.74108f90.js"><link rel="prefetch" href="/assets/js/35.49c875bb.js"><link rel="prefetch" href="/assets/js/350.ed54e76d.js"><link rel="prefetch" href="/assets/js/351.d021fc45.js"><link rel="prefetch" href="/assets/js/352.ceb13107.js"><link rel="prefetch" href="/assets/js/353.9c6e59fc.js"><link rel="prefetch" href="/assets/js/354.7bb11f5f.js"><link rel="prefetch" href="/assets/js/355.666beb97.js"><link rel="prefetch" href="/assets/js/356.f41f057b.js"><link rel="prefetch" href="/assets/js/36.a7843c2f.js"><link rel="prefetch" href="/assets/js/37.430742bd.js"><link rel="prefetch" href="/assets/js/38.d190213c.js"><link rel="prefetch" href="/assets/js/39.86d33c09.js"><link rel="prefetch" href="/assets/js/4.20d62a93.js"><link rel="prefetch" href="/assets/js/40.d1ce04c6.js"><link rel="prefetch" href="/assets/js/41.3ed5ffa1.js"><link rel="prefetch" href="/assets/js/42.bec123d0.js"><link rel="prefetch" href="/assets/js/43.7db6fe10.js"><link rel="prefetch" href="/assets/js/44.593ee985.js"><link rel="prefetch" href="/assets/js/45.b8d850d1.js"><link rel="prefetch" href="/assets/js/46.4e4bef9e.js"><link rel="prefetch" href="/assets/js/47.087b1f4d.js"><link rel="prefetch" href="/assets/js/48.0ce2743d.js"><link rel="prefetch" href="/assets/js/49.8f157751.js"><link rel="prefetch" href="/assets/js/50.da608c2b.js"><link rel="prefetch" href="/assets/js/51.26324433.js"><link rel="prefetch" href="/assets/js/52.dabac7fa.js"><link rel="prefetch" href="/assets/js/53.8df831bd.js"><link rel="prefetch" href="/assets/js/54.3d914f41.js"><link rel="prefetch" href="/assets/js/55.f7713637.js"><link rel="prefetch" href="/assets/js/56.e8a95ed9.js"><link rel="prefetch" href="/assets/js/57.99f9071d.js"><link rel="prefetch" href="/assets/js/58.92842dbe.js"><link rel="prefetch" href="/assets/js/59.d9e6cea2.js"><link rel="prefetch" href="/assets/js/6.e8358ecb.js"><link rel="prefetch" href="/assets/js/60.62e4e6fc.js"><link rel="prefetch" href="/assets/js/62.bc724627.js"><link rel="prefetch" href="/assets/js/63.45aac216.js"><link rel="prefetch" href="/assets/js/64.2993f50d.js"><link rel="prefetch" href="/assets/js/65.93592a18.js"><link rel="prefetch" href="/assets/js/66.0014bfa0.js"><link rel="prefetch" href="/assets/js/67.06bdb67d.js"><link rel="prefetch" href="/assets/js/68.b5baecde.js"><link rel="prefetch" href="/assets/js/69.453c4aa4.js"><link rel="prefetch" href="/assets/js/7.2a1566c4.js"><link rel="prefetch" href="/assets/js/70.0f974374.js"><link rel="prefetch" href="/assets/js/71.577b381c.js"><link rel="prefetch" href="/assets/js/72.ddee11d5.js"><link rel="prefetch" href="/assets/js/73.30433f94.js"><link rel="prefetch" href="/assets/js/74.dfade33e.js"><link rel="prefetch" href="/assets/js/75.05899d44.js"><link rel="prefetch" href="/assets/js/76.06e9db21.js"><link rel="prefetch" href="/assets/js/77.42dbb140.js"><link rel="prefetch" href="/assets/js/78.0a28dff4.js"><link rel="prefetch" href="/assets/js/79.d9c8b827.js"><link rel="prefetch" href="/assets/js/8.c2f2fc17.js"><link rel="prefetch" href="/assets/js/80.3a8d41f6.js"><link rel="prefetch" href="/assets/js/81.df17d28e.js"><link rel="prefetch" href="/assets/js/82.c51860b7.js"><link rel="prefetch" href="/assets/js/83.84d57fa5.js"><link rel="prefetch" href="/assets/js/84.3d0659ab.js"><link rel="prefetch" href="/assets/js/85.d0cdbcbd.js"><link rel="prefetch" href="/assets/js/86.a01d4cb3.js"><link rel="prefetch" href="/assets/js/87.fac4a95e.js"><link rel="prefetch" href="/assets/js/88.019abf7d.js"><link rel="prefetch" href="/assets/js/89.8a272cbe.js"><link rel="prefetch" href="/assets/js/9.54693f65.js"><link rel="prefetch" href="/assets/js/90.78e38bd8.js"><link rel="prefetch" href="/assets/js/91.e6fc4d97.js"><link rel="prefetch" href="/assets/js/92.c76d8caa.js"><link rel="prefetch" href="/assets/js/93.f452fbfa.js"><link rel="prefetch" href="/assets/js/94.b8148d22.js"><link rel="prefetch" href="/assets/js/95.6c9c242e.js"><link rel="prefetch" href="/assets/js/96.ebcb67dc.js"><link rel="prefetch" href="/assets/js/97.51960647.js"><link rel="prefetch" href="/assets/js/98.f1d7b3d5.js"><link rel="prefetch" href="/assets/js/99.2cfad927.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.b18024e9.js">
    <link rel="stylesheet" href="/assets/css/0.styles.89e32c3d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/zh/" class="home-link router-link-active"><!----> <span class="site-name">狸猫小僧</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/zh/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/zh/guide/" class="nav-link">
  指南
</a></div><div class="nav-item"><a href="/zh/interview/" class="nav-link">
  面试
</a></div><div class="nav-item"><a href="/zh/DevBasic/" class="nav-link">
  基础
</a></div><div class="nav-item"><a href="/zh/DevAdvance/" class="nav-link router-link-active">
  高级
</a></div><div class="nav-item"><a href="/zh/CloudNative/" class="nav-link">
  云原生
</a></div><div class="nav-item"><a href="/zh/Frontend/" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/zh/Media/" class="nav-link">
  多媒体
</a></div><div class="nav-item"><a href="/zh/DevOthers/" class="nav-link">
  杂谈
</a></div><div class="nav-item"><a href="/zh/article/" class="nav-link">
  文章
</a></div><div class="nav-item"><a href="/zh/about/" class="nav-link">
  关于
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">选择语言</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/" class="nav-link">
  English
</a></li><li class="dropdown-item"><!----> <a href="/zh/DevAdvance/SpringBoot/Integration/10-整合SpringSecurity实现权限注解+JWT登录认证.html" class="nav-link">
  简体中文
</a></li></ul></div></div> <a href="https://github.com/zhengxiaochuan" target="_blank" rel="noopener noreferrer" class="repo-link">
    官网
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/zh/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/zh/guide/" class="nav-link">
  指南
</a></div><div class="nav-item"><a href="/zh/interview/" class="nav-link">
  面试
</a></div><div class="nav-item"><a href="/zh/DevBasic/" class="nav-link">
  基础
</a></div><div class="nav-item"><a href="/zh/DevAdvance/" class="nav-link router-link-active">
  高级
</a></div><div class="nav-item"><a href="/zh/CloudNative/" class="nav-link">
  云原生
</a></div><div class="nav-item"><a href="/zh/Frontend/" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/zh/Media/" class="nav-link">
  多媒体
</a></div><div class="nav-item"><a href="/zh/DevOthers/" class="nav-link">
  杂谈
</a></div><div class="nav-item"><a href="/zh/article/" class="nav-link">
  文章
</a></div><div class="nav-item"><a href="/zh/about/" class="nav-link">
  关于
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">选择语言</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/" class="nav-link">
  English
</a></li><li class="dropdown-item"><!----> <a href="/zh/DevAdvance/SpringBoot/Integration/10-整合SpringSecurity实现权限注解+JWT登录认证.html" class="nav-link">
  简体中文
</a></li></ul></div></div> <a href="https://github.com/zhengxiaochuan" target="_blank" rel="noopener noreferrer" class="repo-link">
    官网
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>SpringBoot基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>SpringBoot整合</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/zh/DevAdvance/SpringBoot/Integration/01-集成Mybatis通用mapper和pagehelper.html" class="sidebar-link">01-集成Mybatis的数据库连接池、通用mapper、pagehelper等</a></li><li><a href="/zh/DevAdvance/SpringBoot/Integration/02-全局异常处理.html" class="sidebar-link">02-全局异常处理</a></li><li><a href="/zh/DevAdvance/SpringBoot/Integration/03-JSR-303实现请求参数校验.html" class="sidebar-link">03-JSR-303实现请求参数校验</a></li><li><a href="/zh/DevAdvance/SpringBoot/Integration/04-整合Swagger2生成API文档.html" class="sidebar-link">04-整合Swagger2生成API文档</a></li><li><a href="/zh/DevAdvance/SpringBoot/Integration/05-集成JWT实现token验证.html" class="sidebar-link">05-集成JWT实现token验证</a></li><li><a href="/zh/DevAdvance/SpringBoot/Integration/06-集成定时任务.html" class="sidebar-link">06-集成定时任务</a></li><li><a href="/zh/DevAdvance/SpringBoot/Integration/07-集成邮件服务.html" class="sidebar-link">07-集成邮件服务</a></li><li><a href="/zh/DevAdvance/SpringBoot/Integration/08-整合Redis.html" class="sidebar-link">08-整合Redis</a></li><li><a href="/zh/DevAdvance/SpringBoot/Integration/09-整合阿里云短信.html" class="sidebar-link">09-整合阿里云短信服务</a></li><li><a href="/zh/DevAdvance/SpringBoot/Integration/10-整合SpringSecurity实现权限注解+JWT登录认证.html" class="active sidebar-link">10-整合SpringSecurity实现权限注解+JWT登录认证</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/zh/DevAdvance/SpringBoot/Integration/10-整合SpringSecurity实现权限注解+JWT登录认证.html#一-说明" class="sidebar-link">一.说明</a></li><li class="sidebar-sub-header"><a href="/zh/DevAdvance/SpringBoot/Integration/10-整合SpringSecurity实现权限注解+JWT登录认证.html#二-项目环境" class="sidebar-link">二.项目环境</a></li><li class="sidebar-sub-header"><a href="/zh/DevAdvance/SpringBoot/Integration/10-整合SpringSecurity实现权限注解+JWT登录认证.html#三-编写项目基础类" class="sidebar-link">三.编写项目基础类</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/zh/DevAdvance/SpringBoot/Integration/10-整合SpringSecurity实现权限注解+JWT登录认证.html#jwt工具类" class="sidebar-link">JWT工具类</a></li><li class="sidebar-sub-header"><a href="/zh/DevAdvance/SpringBoot/Integration/10-整合SpringSecurity实现权限注解+JWT登录认证.html#暂无权限处理类" class="sidebar-link">暂无权限处理类</a></li><li class="sidebar-sub-header"><a href="/zh/DevAdvance/SpringBoot/Integration/10-整合SpringSecurity实现权限注解+JWT登录认证.html#用户未登录处理类" class="sidebar-link">用户未登录处理类</a></li><li class="sidebar-sub-header"><a href="/zh/DevAdvance/SpringBoot/Integration/10-整合SpringSecurity实现权限注解+JWT登录认证.html#登录失败处理类" class="sidebar-link">登录失败处理类</a></li><li class="sidebar-sub-header"><a href="/zh/DevAdvance/SpringBoot/Integration/10-整合SpringSecurity实现权限注解+JWT登录认证.html#登录成功处理类" class="sidebar-link">登录成功处理类</a></li><li class="sidebar-sub-header"><a href="/zh/DevAdvance/SpringBoot/Integration/10-整合SpringSecurity实现权限注解+JWT登录认证.html#登出成功处理类" class="sidebar-link">登出成功处理类</a></li></ul></li><li class="sidebar-sub-header"><a href="/zh/DevAdvance/SpringBoot/Integration/10-整合SpringSecurity实现权限注解+JWT登录认证.html#四-编写security核心类" class="sidebar-link">四.编写Security核心类</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/zh/DevAdvance/SpringBoot/Integration/10-整合SpringSecurity实现权限注解+JWT登录认证.html#自定义登录验证类" class="sidebar-link">自定义登录验证类</a></li><li class="sidebar-sub-header"><a href="/zh/DevAdvance/SpringBoot/Integration/10-整合SpringSecurity实现权限注解+JWT登录认证.html#自定义permissionevaluator注解验证" class="sidebar-link">自定义PermissionEvaluator注解验证</a></li><li class="sidebar-sub-header"><a href="/zh/DevAdvance/SpringBoot/Integration/10-整合SpringSecurity实现权限注解+JWT登录认证.html#springsecurity核心配置类" class="sidebar-link">SpringSecurity核心配置类</a></li></ul></li><li class="sidebar-sub-header"><a href="/zh/DevAdvance/SpringBoot/Integration/10-整合SpringSecurity实现权限注解+JWT登录认证.html#五-编写jwt拦截类" class="sidebar-link">五.编写JWT拦截类</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/zh/DevAdvance/SpringBoot/Integration/10-整合SpringSecurity实现权限注解+JWT登录认证.html#jwt接口请求校验拦截器" class="sidebar-link">JWT接口请求校验拦截器</a></li></ul></li><li class="sidebar-sub-header"><a href="/zh/DevAdvance/SpringBoot/Integration/10-整合SpringSecurity实现权限注解+JWT登录认证.html#六-权限注解和haspermission权限扩展" class="sidebar-link">六.权限注解和hasPermission权限扩展</a></li><li class="sidebar-sub-header"><a href="/zh/DevAdvance/SpringBoot/Integration/10-整合SpringSecurity实现权限注解+JWT登录认证.html#七-测试" class="sidebar-link">七.测试</a></li><li class="sidebar-sub-header"><a href="/zh/DevAdvance/SpringBoot/Integration/10-整合SpringSecurity实现权限注解+JWT登录认证.html#八-项目源码" class="sidebar-link">八.项目源码</a></li></ul></li><li><a href="/zh/DevAdvance/SpringBoot/Integration/11-整合SpringRetry.html" class="sidebar-link">11-整合SpringRetry</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>SpringSecurity</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>编程方法论</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>微服务</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>微服务技术运用</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Docker容器</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Kubernetes</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>解决方案</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_10-整合springsecurity实现权限注解-jwt登录认证"><a href="#_10-整合springsecurity实现权限注解-jwt登录认证" class="header-anchor">#</a> 10-整合SpringSecurity实现权限注解+JWT登录认证</h1> <h2 id="一-说明"><a href="#一-说明" class="header-anchor">#</a> 一.说明</h2> <p>SpringSecurity是一个用于Java 企业级应用程序的安全框架，主要包含用户认证和用户授权两个方面。相比较Shiro而言，Security功能更加的强大，它可以很容易地扩展以满足更多安全控制方面的需求。但也相对它的学习成本会更高，两种框架各有利弊。实际开发中还是要根据业务和项目的需求来决定使用哪一种。</p> <p>JWT是在Web应用中安全传递信息的规范，从本质上来说是Token的演变，是一种生成加密用户身份信息的Token，特别适用于分布式单点登陆的场景，无需在服务端保存用户的认证信息，而是直接对Token进行校验获取用户信息，使单点登录更为简单灵活。</p> <h2 id="二-项目环境"><a href="#二-项目环境" class="header-anchor">#</a> 二.项目环境</h2> <p>SpringBoot版本:  2.1.6</p> <p>SpringSecurity版本:   5.1.5</p> <p>MyBatis-Plus版本:   3.1.0</p> <p>JDK版本:  1.8</p> <p>数据表(SQL文件在项目中):数据库中测试号的密码进行了加密,密码皆为123456</p> <table><thead><tr><th style="text-align:left;">数据表名</th> <th style="text-align:left;">中文表名</th> <th style="text-align:left;">备注说明</th></tr></thead> <tbody><tr><td style="text-align:left;">sys_user</td> <td style="text-align:left;">系统用户表</td> <td style="text-align:left;">基础表</td></tr> <tr><td style="text-align:left;">sys_menu</td> <td style="text-align:left;">权限表</td> <td style="text-align:left;">基础表</td></tr> <tr><td style="text-align:left;">sys_role</td> <td style="text-align:left;">角色表</td> <td style="text-align:left;">基础表</td></tr> <tr><td style="text-align:left;">sys_role_menu</td> <td style="text-align:left;">角色与权限关系表</td> <td style="text-align:left;">中间表</td></tr> <tr><td style="text-align:left;">sys_user_role</td> <td style="text-align:left;">用户与角色关系表</td> <td style="text-align:left;">中间表</td></tr></tbody></table> <p>Maven依赖如下：</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>mysql<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>mysql-connector-java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>runtime<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.projectlombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>lombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>optional</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>optional</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!--Security依赖 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-security<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- MybatisPlus 核心库 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.baomidou<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>mybatis-plus-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.1.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- 引入阿里数据库连接池 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>druid<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.1.6<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- StringUtilS工具 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.commons<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>commons-lang3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.5<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- JSON工具 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>fastjson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.2.45<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- JWT依赖 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.security<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-security-jwt<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0.9.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.jsonwebtoken<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jjwt<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.9.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br></div></div><p>配置如下:</p> <div class="language-properties line-numbers-mode"><pre class="language-properties"><code><span class="token comment"># 配置端口</span>
<span class="token attr-name">server</span><span class="token punctuation">:</span>
<span class="token attr-name">  port</span><span class="token punctuation">:</span> <span class="token attr-value">8764</span>
<span class="token attr-name">spring</span><span class="token punctuation">:</span>
<span class="token comment">  # 配置数据源</span>
<span class="token attr-name">  datasource</span><span class="token punctuation">:</span>
<span class="token attr-name">    driver-class-name</span><span class="token punctuation">:</span> <span class="token attr-value">com.mysql.cj.jdbc.Driver</span>
<span class="token attr-name">    url</span><span class="token punctuation">:</span> <span class="token attr-value">jdbc:mysql://localhost:3306/spring_security_demo?serverTimezone=UTC&amp;useUnicode=true&amp;characterEncoding=utf-8&amp;zeroDateTimeBehavior=convertToNull&amp;useSSL=false</span>
<span class="token attr-name">    username</span><span class="token punctuation">:</span> <span class="token attr-value">root</span>
<span class="token attr-name">    password</span><span class="token punctuation">:</span> <span class="token attr-value">123456</span>
<span class="token attr-name">    type</span><span class="token punctuation">:</span> <span class="token attr-value">com.alibaba.druid.pool.DruidDataSource</span>
<span class="token comment"># JWT配置</span>
<span class="token attr-name">jwt</span><span class="token punctuation">:</span>
<span class="token comment">  # 密匙KEY</span>
<span class="token attr-name">  secret</span><span class="token punctuation">:</span> <span class="token attr-value">JWTSecret</span>
<span class="token comment">  # HeaderKEY</span>
<span class="token attr-name">  tokenHeader</span><span class="token punctuation">:</span> <span class="token attr-value">Authorization</span>
<span class="token comment">  # Token前缀字符</span>
<span class="token attr-name">  tokenPrefix</span><span class="token punctuation">:</span> <span class="token attr-value">Sans-</span>
<span class="token comment">  # 过期时间 单位秒(1天后过期=86400 7天后过期=604800)</span>
<span class="token attr-name">  expiration</span><span class="token punctuation">:</span> <span class="token attr-value">86400</span>
<span class="token comment">  # 配置不需要认证的接口</span>
<span class="token attr-name">  antMatchers</span><span class="token punctuation">:</span> <span class="token attr-value">/index,/login/**,/favicon.ico</span>
<span class="token comment"># Mybatis-plus相关配置</span>
<span class="token attr-name">mybatis-plus</span><span class="token punctuation">:</span>
<span class="token comment">  # xml扫描，多个目录用逗号或者分号分隔（告诉 Mapper 所对应的 XML 文件位置）</span>
<span class="token attr-name">  mapper-locations</span><span class="token punctuation">:</span> <span class="token attr-value">classpath:mapper/*.xml</span>
<span class="token comment">  # 以下配置均有默认值,可以不设置</span>
<span class="token attr-name">  global-config</span><span class="token punctuation">:</span>
<span class="token attr-name">    db-config</span><span class="token punctuation">:</span>
<span class="token comment">      #主键类型 AUTO:&quot;数据库ID自增&quot; INPUT:&quot;用户输入ID&quot;,ID_WORKER:&quot;全局唯一ID (数字类型唯一ID)&quot;, UUID:&quot;全局唯一ID UUID&quot;;</span>
<span class="token attr-name">      id-type</span><span class="token punctuation">:</span> <span class="token attr-value">AUTO</span>
<span class="token comment">      #字段策略 IGNORED:&quot;忽略判断&quot;  NOT_NULL:&quot;非 NULL 判断&quot;)  NOT_EMPTY:&quot;非空判断&quot;</span>
<span class="token attr-name">      field-strategy</span><span class="token punctuation">:</span> <span class="token attr-value">NOT_EMPTY</span>
<span class="token comment">      #数据库类型</span>
<span class="token attr-name">      db-type</span><span class="token punctuation">:</span> <span class="token attr-value">MYSQL</span>
<span class="token attr-name">  configuration</span><span class="token punctuation">:</span>
<span class="token comment">    # 是否开启自动驼峰命名规则映射:从数据库列名到Java属性驼峰命名的类似映射</span>
<span class="token attr-name">    map-underscore-to-camel-case</span><span class="token punctuation">:</span> <span class="token attr-value">true</span>
<span class="token comment">    # 返回map时true:当查询数据为空时字段返回为null,false:不加这个查询数据为空时，字段将被隐藏</span>
<span class="token attr-name">    call-setters-on-nulls</span><span class="token punctuation">:</span> <span class="token attr-value">true</span>
<span class="token comment">    # 这个配置会将执行的sql打印出来，在开发或测试的时候可以用</span>
<span class="token attr-name">    log-impl</span><span class="token punctuation">:</span> <span class="token attr-value">org.apache.ibatis.logging.stdout.StdOutImpl</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><h2 id="三-编写项目基础类"><a href="#三-编写项目基础类" class="header-anchor">#</a> 三.编写项目基础类</h2> <p>Entity、Dao、Service、及等SpringSecurity用户的Entity、Service类等在这里省略，请参考源码。</p> <h3 id="jwt工具类"><a href="#jwt工具类" class="header-anchor">#</a> JWT工具类</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * JWT工具类
 * @Author RyuZheng
 * @CreateTime 2019/10/2 7:42
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JWTTokenUtil</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * 生成Token
     * @Param selfUserEntity 用户安全实体
     * @Return Token
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">createAccessToken</span><span class="token punctuation">(</span><span class="token class-name">SelfUserEntity</span> selfUserEntity<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// 登陆成功生成JWT</span>
        <span class="token class-name">String</span> token <span class="token operator">=</span> <span class="token class-name">Jwts</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment">// 放入用户名和用户ID</span>
                <span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>selfUserEntity<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span>
                <span class="token comment">// 主题</span>
                <span class="token punctuation">.</span><span class="token function">setSubject</span><span class="token punctuation">(</span>selfUserEntity<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token comment">// 签发时间</span>
                <span class="token punctuation">.</span><span class="token function">setIssuedAt</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token comment">// 签发者</span>
                <span class="token punctuation">.</span><span class="token function">setIssuer</span><span class="token punctuation">(</span><span class="token string">&quot;sans&quot;</span><span class="token punctuation">)</span>
                <span class="token comment">// 自定义属性 放入用户拥有权限</span>
                <span class="token punctuation">.</span><span class="token function">claim</span><span class="token punctuation">(</span><span class="token string">&quot;authorities&quot;</span><span class="token punctuation">,</span> JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>selfUserEntity<span class="token punctuation">.</span><span class="token function">getAuthorities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token comment">// 失效时间</span>
                <span class="token punctuation">.</span><span class="token function">setExpiration</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token class-name">JWTConfig</span><span class="token punctuation">.</span>expiration<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token comment">// 签名算法和密钥</span>
                <span class="token punctuation">.</span><span class="token function">signWith</span><span class="token punctuation">(</span><span class="token class-name">SignatureAlgorithm</span><span class="token punctuation">.</span>HS512<span class="token punctuation">,</span> <span class="token class-name">JWTConfig</span><span class="token punctuation">.</span>secret<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">compact</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> token<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><h3 id="暂无权限处理类"><a href="#暂无权限处理类" class="header-anchor">#</a> 暂无权限处理类</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * @Description 暂无权限处理类
 * @Author RyuZheng
 * @CreateTime 2019/10/3 8:39
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserAuthAccessDeniedHandler</span> <span class="token keyword">implements</span> <span class="token class-name">AccessDeniedHandler</span><span class="token punctuation">{</span>
    <span class="token comment">/**
     * 暂无权限返回结果
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">AccessDeniedException</span> exception<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">ResultUtil</span><span class="token punctuation">.</span><span class="token function">responseJson</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span><span class="token class-name">ResultUtil</span><span class="token punctuation">.</span><span class="token function">resultCode</span><span class="token punctuation">(</span><span class="token number">403</span><span class="token punctuation">,</span><span class="token string">&quot;未授权&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h3 id="用户未登录处理类"><a href="#用户未登录处理类" class="header-anchor">#</a> 用户未登录处理类</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 用户未登录处理类
 * @Author RyuZheng
 * @CreateTime 2019/10/3 8:55
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserAuthenticationEntryPointHandler</span> <span class="token keyword">implements</span> <span class="token class-name">AuthenticationEntryPoint</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 用户未登录返回结果
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">commence</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">AuthenticationException</span> exception<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">ResultUtil</span><span class="token punctuation">.</span><span class="token function">responseJson</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span><span class="token class-name">ResultUtil</span><span class="token punctuation">.</span><span class="token function">resultCode</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">,</span><span class="token string">&quot;未登录&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h3 id="登录失败处理类"><a href="#登录失败处理类" class="header-anchor">#</a> 登录失败处理类</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * @Description 登录失败处理类
 * @Author RyuZheng
 * @CreateTime 2019/10/3 9:06
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserLoginFailureHandler</span> <span class="token keyword">implements</span> <span class="token class-name">AuthenticationFailureHandler</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 登录失败返回结果
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onAuthenticationFailure</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">AuthenticationException</span> exception<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// 这些对于操作的处理类可以根据不同异常进行不同处理</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>exception <span class="token keyword">instanceof</span> <span class="token class-name">UsernameNotFoundException</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;【登录失败】&quot;</span><span class="token operator">+</span>exception<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">ResultUtil</span><span class="token punctuation">.</span><span class="token function">responseJson</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span><span class="token class-name">ResultUtil</span><span class="token punctuation">.</span><span class="token function">resultCode</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">,</span><span class="token string">&quot;用户名不存在&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>exception <span class="token keyword">instanceof</span> <span class="token class-name">LockedException</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;【登录失败】&quot;</span><span class="token operator">+</span>exception<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">ResultUtil</span><span class="token punctuation">.</span><span class="token function">responseJson</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span><span class="token class-name">ResultUtil</span><span class="token punctuation">.</span><span class="token function">resultCode</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">,</span><span class="token string">&quot;用户被冻结&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>exception <span class="token keyword">instanceof</span> <span class="token class-name">BadCredentialsException</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;【登录失败】&quot;</span><span class="token operator">+</span>exception<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">ResultUtil</span><span class="token punctuation">.</span><span class="token function">responseJson</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span><span class="token class-name">ResultUtil</span><span class="token punctuation">.</span><span class="token function">resultCode</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">,</span><span class="token string">&quot;用户名密码不正确&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">ResultUtil</span><span class="token punctuation">.</span><span class="token function">responseJson</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span><span class="token class-name">ResultUtil</span><span class="token punctuation">.</span><span class="token function">resultCode</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">,</span><span class="token string">&quot;登录失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><h3 id="登录成功处理类"><a href="#登录成功处理类" class="header-anchor">#</a> 登录成功处理类</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * @Description 登录成功处理类
 * @Author RyuZheng
 * @CreateTime 2019/10/3 9:13
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserLoginSuccessHandler</span> <span class="token keyword">implements</span> <span class="token class-name">AuthenticationSuccessHandler</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 登录成功返回结果
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onAuthenticationSuccess</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Authentication</span> authentication<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// 组装JWT</span>
        <span class="token class-name">SelfUserEntity</span> selfUserEntity <span class="token operator">=</span>  <span class="token punctuation">(</span><span class="token class-name">SelfUserEntity</span><span class="token punctuation">)</span> authentication<span class="token punctuation">.</span><span class="token function">getPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> token <span class="token operator">=</span> <span class="token class-name">JWTTokenUtil</span><span class="token punctuation">.</span><span class="token function">createAccessToken</span><span class="token punctuation">(</span>selfUserEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        token <span class="token operator">=</span> <span class="token class-name">JWTConfig</span><span class="token punctuation">.</span>tokenPrefix <span class="token operator">+</span> token<span class="token punctuation">;</span>
        <span class="token comment">// 封装返回参数</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> resultData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        resultData<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;code&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;200&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        resultData<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;msg&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;登录成功&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        resultData<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;token&quot;</span><span class="token punctuation">,</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ResultUtil</span><span class="token punctuation">.</span><span class="token function">responseJson</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span>resultData<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><h3 id="登出成功处理类"><a href="#登出成功处理类" class="header-anchor">#</a> 登出成功处理类</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 用户登出类
 * @Author RyuZheng
 * @CreateTime 2019/10/3 9:42
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserLogoutSuccessHandler</span> <span class="token keyword">implements</span> <span class="token class-name">LogoutSuccessHandler</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 用户登出返回结果
     * 这里应该让前端清除掉Token
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onLogoutSuccess</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Authentication</span> authentication<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> resultData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        resultData<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;code&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;200&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        resultData<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;msg&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;登出成功&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">clearContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ResultUtil</span><span class="token punctuation">.</span><span class="token function">responseJson</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span><span class="token class-name">ResultUtil</span><span class="token punctuation">.</span><span class="token function">resultSuccess</span><span class="token punctuation">(</span>resultData<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h2 id="四-编写security核心类"><a href="#四-编写security核心类" class="header-anchor">#</a> 四.编写Security核心类</h2> <h3 id="自定义登录验证类"><a href="#自定义登录验证类" class="header-anchor">#</a> 自定义登录验证类</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 自定义登录验证
 * @Author RyuZheng
 * @CreateTime 2019/10/1 19:11
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserAuthenticationProvider</span> <span class="token keyword">implements</span> <span class="token class-name">AuthenticationProvider</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">SelfUserDetailsService</span> selfUserDetailsService<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">SysUserService</span> sysUserService<span class="token punctuation">;</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Authentication</span> <span class="token function">authenticate</span><span class="token punctuation">(</span><span class="token class-name">Authentication</span> authentication<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">AuthenticationException</span> <span class="token punctuation">{</span>
        <span class="token comment">// 获取表单输入中返回的用户名</span>
        <span class="token class-name">String</span> userName <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> authentication<span class="token punctuation">.</span><span class="token function">getPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取表单中输入的密码</span>
        <span class="token class-name">String</span> password <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> authentication<span class="token punctuation">.</span><span class="token function">getCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 查询用户是否存在</span>
        <span class="token class-name">SelfUserEntity</span> userInfo <span class="token operator">=</span> selfUserDetailsService<span class="token punctuation">.</span><span class="token function">loadUserByUsername</span><span class="token punctuation">(</span>userName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>userInfo <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UsernameNotFoundException</span><span class="token punctuation">(</span><span class="token string">&quot;用户名不存在&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 我们还要判断密码是否正确，这里我们的密码使用BCryptPasswordEncoder进行加密的</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> userInfo<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BadCredentialsException</span><span class="token punctuation">(</span><span class="token string">&quot;密码不正确&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 还可以加一些其他信息的判断，比如用户账号已停用等判断</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>userInfo<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;PROHIBIT&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">LockedException</span><span class="token punctuation">(</span><span class="token string">&quot;该用户已被冻结&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 角色集合</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GrantedAuthority</span><span class="token punctuation">&gt;</span></span> authorities <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 查询用户角色</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysRoleEntity</span><span class="token punctuation">&gt;</span></span> sysRoleEntityList <span class="token operator">=</span> sysUserService<span class="token punctuation">.</span><span class="token function">selectSysRoleByUserId</span><span class="token punctuation">(</span>userInfo<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SysRoleEntity</span> sysRoleEntity<span class="token operator">:</span> sysRoleEntityList<span class="token punctuation">)</span><span class="token punctuation">{</span>
            authorities<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SimpleGrantedAuthority</span><span class="token punctuation">(</span><span class="token string">&quot;ROLE_&quot;</span> <span class="token operator">+</span> sysRoleEntity<span class="token punctuation">.</span><span class="token function">getRoleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        userInfo<span class="token punctuation">.</span><span class="token function">setAuthorities</span><span class="token punctuation">(</span>authorities<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 进行登录</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span><span class="token punctuation">(</span>userInfo<span class="token punctuation">,</span> password<span class="token punctuation">,</span> authorities<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">supports</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> authentication<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div><h3 id="自定义permissionevaluator注解验证"><a href="#自定义permissionevaluator注解验证" class="header-anchor">#</a> 自定义PermissionEvaluator注解验证</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 自定义权限注解验证
 * @Author RyuZheng
 * @CreateTime 2019/10/6 13:31
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserPermissionEvaluator</span> <span class="token keyword">implements</span> <span class="token class-name">PermissionEvaluator</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">SysUserService</span> sysUserService<span class="token punctuation">;</span>
    
    <span class="token comment">/**
     * hasPermission鉴权方法
     * 这里仅仅判断PreAuthorize注解中的权限表达式
     * 实际中可以根据业务需求设计数据库通过targetUrl和permission做更复杂鉴权
     * @Param  authentication  用户身份
     * @Param  targetUrl  请求路径
     * @Param  permission 请求路径权限
     * @Return boolean 是否通过
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">hasPermission</span><span class="token punctuation">(</span><span class="token class-name">Authentication</span> authentication<span class="token punctuation">,</span> <span class="token class-name">Object</span> targetUrl<span class="token punctuation">,</span> <span class="token class-name">Object</span> permission<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 获取用户信息</span>
        <span class="token class-name">SelfUserEntity</span> selfUserEntity <span class="token operator">=</span><span class="token punctuation">(</span><span class="token class-name">SelfUserEntity</span><span class="token punctuation">)</span> authentication<span class="token punctuation">.</span><span class="token function">getPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 查询用户权限(这里可以将权限放入缓存中提升效率)</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> permissions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysMenuEntity</span><span class="token punctuation">&gt;</span></span> sysMenuEntityList <span class="token operator">=</span> sysUserService<span class="token punctuation">.</span><span class="token function">selectSysMenuByUserId</span><span class="token punctuation">(</span>selfUserEntity<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SysMenuEntity</span> sysMenuEntity<span class="token operator">:</span>sysMenuEntityList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            permissions<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>sysMenuEntity<span class="token punctuation">.</span><span class="token function">getPermission</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 权限对比</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>permissions<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>permission<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">hasPermission</span><span class="token punctuation">(</span><span class="token class-name">Authentication</span> authentication<span class="token punctuation">,</span> <span class="token class-name">Serializable</span> targetId<span class="token punctuation">,</span> <span class="token class-name">String</span> targetType<span class="token punctuation">,</span> <span class="token class-name">Object</span> permission<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><h3 id="springsecurity核心配置类"><a href="#springsecurity核心配置类" class="header-anchor">#</a> SpringSecurity核心配置类</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * SpringSecurity核心配置类
 * @Author RyuZheng
 * @CreateTime 2019/10/1 9:40
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableWebSecurity</span>
<span class="token annotation punctuation">@EnableGlobalMethodSecurity</span><span class="token punctuation">(</span>prePostEnabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token comment">//开启权限注解,默认是关闭的</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecurityConfig</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 自定义登录成功处理器
     */</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">UserLoginSuccessHandler</span> userLoginSuccessHandler<span class="token punctuation">;</span>
    <span class="token comment">/**
     * 自定义登录失败处理器
     */</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">UserLoginFailureHandler</span> userLoginFailureHandler<span class="token punctuation">;</span>
    <span class="token comment">/**
     * 自定义注销成功处理器
     */</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">UserLogoutSuccessHandler</span> userLogoutSuccessHandler<span class="token punctuation">;</span>
    <span class="token comment">/**
     * 自定义暂无权限处理器
     */</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">UserAuthAccessDeniedHandler</span> userAuthAccessDeniedHandler<span class="token punctuation">;</span>
    <span class="token comment">/**
     * 自定义未登录的处理器
     */</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">UserAuthenticationEntryPointHandler</span> userAuthenticationEntryPointHandler<span class="token punctuation">;</span>
    <span class="token comment">/**
     * 自定义登录逻辑验证器
     */</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">UserAuthenticationProvider</span> userAuthenticationProvider<span class="token punctuation">;</span>
    
    <span class="token comment">/**
     * 加密方式
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">BCryptPasswordEncoder</span> <span class="token function">bCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/**
     * 注入自定义PermissionEvaluator
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">DefaultWebSecurityExpressionHandler</span> <span class="token function">userSecurityExpressionHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">DefaultWebSecurityExpressionHandler</span> handler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultWebSecurityExpressionHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        handler<span class="token punctuation">.</span><span class="token function">setPermissionEvaluator</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">UserPermissionEvaluator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> handler<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">/**
     * 配置登录验证逻辑
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationManagerBuilder</span> auth<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//这里可启用我们自己的登陆验证逻辑</span>
        auth<span class="token punctuation">.</span><span class="token function">authenticationProvider</span><span class="token punctuation">(</span>userAuthenticationProvider<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">/**
     * 配置security的控制逻辑
     * @Param  http 请求
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        http<span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment">//不进行权限验证的请求或资源(从配置文件中读取)</span>
               <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token class-name">JWTConfig</span><span class="token punctuation">.</span>antMatchers<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment">//其他的需要登陆后才能访问</span>
                <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment">//配置未登录自定义处理类</span>
                <span class="token punctuation">.</span><span class="token function">httpBasic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authenticationEntryPoint</span><span class="token punctuation">(</span>userAuthenticationEntryPointHandler<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment">//配置登录地址</span>
                <span class="token punctuation">.</span><span class="token function">formLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">loginProcessingUrl</span><span class="token punctuation">(</span><span class="token string">&quot;/login/userLogin&quot;</span><span class="token punctuation">)</span>
                <span class="token comment">//配置登录成功自定义处理类</span>
                <span class="token punctuation">.</span><span class="token function">successHandler</span><span class="token punctuation">(</span>userLoginSuccessHandler<span class="token punctuation">)</span>
                <span class="token comment">//配置登录失败自定义处理类</span>
                <span class="token punctuation">.</span><span class="token function">failureHandler</span><span class="token punctuation">(</span>userLoginFailureHandler<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment">//配置登出地址</span>
                <span class="token punctuation">.</span><span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">logoutUrl</span><span class="token punctuation">(</span><span class="token string">&quot;/login/userLogout&quot;</span><span class="token punctuation">)</span>
                <span class="token comment">//配置用户登出自定义处理类</span>
                <span class="token punctuation">.</span><span class="token function">logoutSuccessHandler</span><span class="token punctuation">(</span>userLogoutSuccessHandler<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment">//配置没有权限自定义处理类</span>
                <span class="token punctuation">.</span><span class="token function">exceptionHandling</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">accessDeniedHandler</span><span class="token punctuation">(</span>userAuthAccessDeniedHandler<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment">// 取消跨站请求伪造防护</span>
                <span class="token punctuation">.</span><span class="token function">csrf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 基于Token不需要session</span>
        http<span class="token punctuation">.</span><span class="token function">sessionManagement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sessionCreationPolicy</span><span class="token punctuation">(</span><span class="token class-name">SessionCreationPolicy</span><span class="token punctuation">.</span>STATELESS<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 禁用缓存</span>
        http<span class="token punctuation">.</span><span class="token function">headers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">cacheControl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 添加JWT过滤器</span>
        http<span class="token punctuation">.</span><span class="token function">addFilter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">JWTAuthenticationTokenFilter</span><span class="token punctuation">(</span><span class="token function">authenticationManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br></div></div><h2 id="五-编写jwt拦截类"><a href="#五-编写jwt拦截类" class="header-anchor">#</a> 五.编写JWT拦截类</h2> <h3 id="jwt接口请求校验拦截器"><a href="#jwt接口请求校验拦截器" class="header-anchor">#</a> JWT接口请求校验拦截器</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * JWT接口请求校验拦截器
 * 请求接口时会进入这里验证Token是否合法和过期
 * @Author RyuZheng
 * @CreateTime 2019/10/5 16:41
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JWTAuthenticationTokenFilter</span> <span class="token keyword">extends</span> <span class="token class-name">BasicAuthenticationFilter</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">JWTAuthenticationTokenFilter</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationManager</span> authenticationManager<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>authenticationManager<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doFilterInternal</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> filterChain<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token comment">// 获取请求头中JWT的Token</span>
        <span class="token class-name">String</span> tokenHeader <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token class-name">JWTConfig</span><span class="token punctuation">.</span>tokenHeader<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span><span class="token operator">!=</span>tokenHeader <span class="token operator">&amp;&amp;</span> tokenHeader<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token class-name">JWTConfig</span><span class="token punctuation">.</span>tokenPrefix<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">// 截取JWT前缀</span>
                <span class="token class-name">String</span> token <span class="token operator">=</span> tokenHeader<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token class-name">JWTConfig</span><span class="token punctuation">.</span>tokenPrefix<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 解析JWT</span>
                <span class="token class-name">Claims</span> claims <span class="token operator">=</span> <span class="token class-name">Jwts</span><span class="token punctuation">.</span><span class="token function">parser</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">setSigningKey</span><span class="token punctuation">(</span><span class="token class-name">JWTConfig</span><span class="token punctuation">.</span>secret<span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">parseClaimsJws</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 获取用户名</span>
                <span class="token class-name">String</span> username <span class="token operator">=</span> claims<span class="token punctuation">.</span><span class="token function">getSubject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">String</span> userId<span class="token operator">=</span>claims<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 获取角色</span>
                    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GrantedAuthority</span><span class="token punctuation">&gt;</span></span> authorities <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">String</span> authority <span class="token operator">=</span> claims<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;authorities&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>authority<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> authorityMap <span class="token operator">=</span> <span class="token class-name">JSONObject</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>authority<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> role <span class="token operator">:</span> authorityMap<span class="token punctuation">)</span><span class="token punctuation">{</span>
                            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>role<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                authorities<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SimpleGrantedAuthority</span><span class="token punctuation">(</span>role<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;authority&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">//组装参数</span>
                    <span class="token class-name">SelfUserEntity</span> selfUserEntity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SelfUserEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    selfUserEntity<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span>claims<span class="token punctuation">.</span><span class="token function">getSubject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    selfUserEntity<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span>claims<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    selfUserEntity<span class="token punctuation">.</span><span class="token function">setAuthorities</span><span class="token punctuation">(</span>authorities<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">UsernamePasswordAuthenticationToken</span> authentication <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span><span class="token punctuation">(</span>selfUserEntity<span class="token punctuation">,</span> userId<span class="token punctuation">,</span> authorities<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAuthentication</span><span class="token punctuation">(</span>authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ExpiredJwtException</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Token过期&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Token无效&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        filterChain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br></div></div><h2 id="六-权限注解和haspermission权限扩展"><a href="#六-权限注解和haspermission权限扩展" class="header-anchor">#</a> 六.权限注解和hasPermission权限扩展</h2> <p>Security允许我们在定义URL方法访问所应有的注解权限时使用SpringEL表达式，在定义所需的访问权限时如果对应的表达式返回结果为true，则表示拥有对应的权限，反之则没有权限，会进入到我们配置的UserAuthAccessDeniedHandler(暂无权限处理类)中进行处理。这里举一些例子，代码中注释有对应的描述。</p> <table><thead><tr><th style="text-align:left;">表达式</th> <th style="text-align:left;">描述</th></tr></thead> <tbody><tr><td style="text-align:left;">hasRole([role])</td> <td style="text-align:left;">当前用户是否拥有指定角色.</td></tr> <tr><td style="text-align:left;">hasAnyRole([role1,role2])</td> <td style="text-align:left;">多个角色是一个以逗号进行分隔的字符串如果当前用户拥有指定角色中的任意一个则返回true.</td></tr> <tr><td style="text-align:left;">hasAuthority([auth])</td> <td style="text-align:left;">等同于hasRole</td></tr> <tr><td style="text-align:left;">hasAnyAuthority([auth1,auth2])</td> <td style="text-align:left;">等同于hasAnyRole</td></tr> <tr><td style="text-align:left;">Principle</td> <td style="text-align:left;">代表当前用户的principle对象</td></tr> <tr><td style="text-align:left;">authentication</td> <td style="text-align:left;">直接从SecurityContext获取的当前Authentication对象</td></tr> <tr><td style="text-align:left;">permitAll</td> <td style="text-align:left;">总是返回true表示允许所有的</td></tr> <tr><td style="text-align:left;">denyAll</td> <td style="text-align:left;">总是返回false表示拒绝所有的</td></tr> <tr><td style="text-align:left;">isAnonymous()</td> <td style="text-align:left;">当前用户是否是一个匿名用户</td></tr> <tr><td style="text-align:left;">isRememberMe()</td> <td style="text-align:left;">表示当前用户是否是通过Remember-Me自动登录的</td></tr> <tr><td style="text-align:left;">isAuthenticated()</td> <td style="text-align:left;">表示当前用户是否已经登录认证成功了</td></tr> <tr><td style="text-align:left;">isFullyAuthenticated()</td> <td style="text-align:left;">如果当前用户既不是一个匿名用户又不是通过Remember-Me自动登录的则返回true</td></tr> <tr><td style="text-align:left;">hasPermission()</td> <td style="text-align:left;">使用扩展表达式需要实现PermissionEvaluator接口</td></tr></tbody></table> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">/**
     * 管理端信息
     * @return Map&lt;String,Object&gt; 返回数据MAP
     */</span>
    <span class="token annotation punctuation">@PreAuthorize</span><span class="token punctuation">(</span><span class="token string">&quot;hasRole('ADMIN')&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/info&quot;</span><span class="token punctuation">,</span>method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span>GET<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">SelfUserEntity</span> userDetails <span class="token operator">=</span> <span class="token class-name">SecurityUtil</span><span class="token punctuation">.</span><span class="token function">getUserInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;title&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;管理端信息&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">,</span>userDetails<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">ResultUtil</span><span class="token punctuation">.</span><span class="token function">resultSuccess</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 拥有ADMIN或者USER角色可以访问
     * @return Map&lt;String,Object&gt; 返回数据MAP
     */</span>
    <span class="token annotation punctuation">@PreAuthorize</span><span class="token punctuation">(</span><span class="token string">&quot;hasAnyRole('ADMIN','USER')&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/list&quot;</span><span class="token punctuation">,</span>method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span>GET<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysUserEntity</span><span class="token punctuation">&gt;</span></span> sysUserEntityList <span class="token operator">=</span> sysUserService<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;title&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;拥有用户或者管理员角色都可以查看&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">,</span>sysUserEntityList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">ResultUtil</span><span class="token punctuation">.</span><span class="token function">resultSuccess</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 拥有ADMIN和USER角色可以访问
     * @return Map&lt;String,Object&gt; 返回数据MAP
     */</span>
    <span class="token annotation punctuation">@PreAuthorize</span><span class="token punctuation">(</span><span class="token string">&quot;hasRole('ADMIN') and hasRole('USER')&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/menuList&quot;</span><span class="token punctuation">,</span>method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span>GET<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">menuList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysMenuEntity</span><span class="token punctuation">&gt;</span></span> sysMenuEntityList <span class="token operator">=</span> sysMenuService<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;title&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;拥有用户和管理员角色都可以查看&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">,</span>sysMenuEntityList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">ResultUtil</span><span class="token punctuation">.</span><span class="token function">resultSuccess</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><p>通常情况下使用hasRole和hasAnyRole基本可以满足大部分鉴权需求,但是有时候面对更复杂的场景上述常规表示式无法完成权限认证,Security也为我们提供了解决方案.通过hasPermission()来扩展表达式.使用hasPermission()首先要实现PermissionEvaluator接口</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 自定义权限注解验证
 * @Author RyuZheng
 * @CreateTime 2019/10/6 13:31
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserPermissionEvaluator</span> <span class="token keyword">implements</span> <span class="token class-name">PermissionEvaluator</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">SysUserService</span> sysUserService<span class="token punctuation">;</span>
    
    <span class="token comment">/**
     * hasPermission鉴权方法
     * 这里仅仅判断PreAuthorize注解中的权限表达式
     * 实际中可以根据业务需求设计数据库通过targetUrl和permission做更复杂鉴权
     * 当然targetUrl不一定是URL可以是数据Id还可以是管理员标识等,这里根据需求自行设计     
     * @param  authentication  用户身份(在使用hasPermission表达式时Authentication参数默认会自动带上)
     * @param  targetUrl  请求路径
     * @param  permission 请求路径权限
     * @return boolean 是否通过
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">hasPermission</span><span class="token punctuation">(</span><span class="token class-name">Authentication</span> authentication<span class="token punctuation">,</span> <span class="token class-name">Object</span> targetUrl<span class="token punctuation">,</span> <span class="token class-name">Object</span> permission<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 获取用户信息</span>
        <span class="token class-name">SelfUserEntity</span> selfUserEntity <span class="token operator">=</span><span class="token punctuation">(</span><span class="token class-name">SelfUserEntity</span><span class="token punctuation">)</span> authentication<span class="token punctuation">.</span><span class="token function">getPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 查询用户权限(这里可以将权限放入缓存中提升效率)</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> permissions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysMenuEntity</span><span class="token punctuation">&gt;</span></span> sysMenuEntityList <span class="token operator">=</span> sysUserService<span class="token punctuation">.</span><span class="token function">selectSysMenuByUserId</span><span class="token punctuation">(</span>selfUserEntity<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SysMenuEntity</span> sysMenuEntity<span class="token operator">:</span>sysMenuEntityList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            permissions<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>sysMenuEntity<span class="token punctuation">.</span><span class="token function">getPermission</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 权限对比</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>permissions<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>permission<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">hasPermission</span><span class="token punctuation">(</span><span class="token class-name">Authentication</span> authentication<span class="token punctuation">,</span> <span class="token class-name">Serializable</span> targetId<span class="token punctuation">,</span> <span class="token class-name">String</span> targetType<span class="token punctuation">,</span> <span class="token class-name">Object</span> permission<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><p>在请求方法上添加hasPermission示例</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">/**
     * 拥有sys:user:info权限可以访问
     * hasPermission 第一个参数是请求路径 第二个参数是权限表达式
     * @Return Map&lt;String,Object&gt; 返回数据MAP
     */</span>
    <span class="token annotation punctuation">@PreAuthorize</span><span class="token punctuation">(</span><span class="token string">&quot;hasPermission('/admin/userList','sys:user:info')&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/userList&quot;</span><span class="token punctuation">,</span>method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span>GET<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">userList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysUserEntity</span><span class="token punctuation">&gt;</span></span> sysUserEntityList <span class="token operator">=</span> sysUserService<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;title&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;拥有sys:user:info权限都可以查看&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">,</span>sysUserEntityList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">ResultUtil</span><span class="token punctuation">.</span><span class="token function">resultSuccess</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>hasPermission可以也可以和其他表达式联合使用</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">/**
     * 拥有ADMIN角色和sys:role:info权限可以访问
     * @Return Map&lt;String,Object&gt; 返回数据MAP
     */</span>
    <span class="token annotation punctuation">@PreAuthorize</span><span class="token punctuation">(</span><span class="token string">&quot;hasRole('ADMIN') and hasPermission('/admin/adminRoleList','sys:role:info')&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/adminRoleList&quot;</span><span class="token punctuation">,</span>method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span>GET<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">adminRoleList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysRoleEntity</span><span class="token punctuation">&gt;</span></span> sysRoleEntityList <span class="token operator">=</span> sysRoleService<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;title&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;拥有ADMIN角色和sys:role:info权限可以访问&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">,</span>sysRoleEntityList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">ResultUtil</span><span class="token punctuation">.</span><span class="token function">resultSuccess</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h2 id="七-测试"><a href="#七-测试" class="header-anchor">#</a> 七.测试</h2> <p>创建测试类，创建账户这里用户加密使用了Security推荐的BCryptPasswordEncoder方法。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span><span class="token class-name">SpringRunner</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpringBootSecurityDemoApplicationTests</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">SysUserService</span> sysUserService<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">BCryptPasswordEncoder</span> bCryptPasswordEncoder<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">SysUserRoleService</span> sysUserRoleService<span class="token punctuation">;</span>


    <span class="token comment">/**
     * 注册用户
     */</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">contextLoads</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 注册用户</span>
        <span class="token class-name">SysUserEntity</span> sysUserEntity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SysUserEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sysUserEntity<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span><span class="token string">&quot;ryu&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sysUserEntity<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span>bCryptPasswordEncoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">&quot;123456&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置用户状态</span>
        sysUserEntity<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token string">&quot;NORMAL&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sysUserService<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>sysUserEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 分配角色 1:ADMIN 2:USER</span>
        <span class="token class-name">SysUserRoleEntity</span> sysUserRoleEntity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SysUserRoleEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sysUserRoleEntity<span class="token punctuation">.</span><span class="token function">setRoleId</span><span class="token punctuation">(</span><span class="token number">2L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sysUserRoleEntity<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>sysUserEntity<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sysUserRoleService<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>sysUserRoleEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>登录USER角色账号，登录成功后我们会获取到身份认证的Token：</p> <p>访问地址： <code>http://localhost:8764/login/userLogin?username=user&amp;password=123456</code></p> <p><img src="/assets/img/20191216134314.94d3e669.png" alt="img"></p> <p>访问USER角色的接口，把上一步获取到的Token设置在Headers中，Key为<code>Authorization</code>，我们之前实现的JWTAuthenticationTokenFilter 拦截器会根据请求头中的Authorization获取并解析Token：</p> <p>访问地址： <code>http://localhost:8764/user/info</code></p> <p><img src="/assets/img/20191216135105.23de7383.png" alt="img"></p> <p>使用USER角色Token访问ADMIN角色的接口，会被拒绝，告知未授权【暂无权限会进入我们定义的UserAuthAccessDeniedHandler这个类进行处理】。</p> <p>访问地址： <code>http://localhost:8764/admin/info</code></p> <p><img src="/assets/img/20191216135313.591891a4.png" alt="img"></p> <p>更换ADMIN角色进行登录并访问ADMIN接口</p> <p>访问地址： <code>http://localhost:8764/admin/info</code></p> <p><img src="/assets/img/20191216135559.2c5593f7.png" alt="img"></p> <h2 id="八-项目源码"><a href="#八-项目源码" class="header-anchor">#</a> 八.项目源码</h2> <p>码云:<a href="https://gitee.com/liselotte/spring-boot-security-demo" target="_blank" rel="noopener noreferrer">gitee.com/liselotte/s…<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>GitHub:<a href="https://github.com/xuyulong2017/my-java-demo" target="_blank" rel="noopener noreferrer">github.com/xuyulong201…<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2020/7/27 上午6:47:52</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/zh/DevAdvance/SpringBoot/Integration/09-整合阿里云短信.html" class="prev">
        09-整合阿里云短信服务
      </a></span> <span class="next"><a href="/zh/DevAdvance/SpringBoot/Integration/11-整合SpringRetry.html">
        11-整合SpringRetry
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.fd7d1168.js" defer></script><script src="/assets/js/5.8188c8a3.js" defer></script><script src="/assets/js/61.a135170d.js" defer></script>
  </body>
</html>
